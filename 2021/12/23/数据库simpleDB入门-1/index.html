<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","version":"8.2.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="数据存储操作系统磁盘访问接口块级接口块定义磁盘看做成多个连续的块，每个块都有唯一的块号。页是内存中跟块同样大小的区域。 如果一个客户端想要修改一个块中的内容，他必须将这个块先读到页中，然后修改页中的相应字节，然后再将该页写回到磁盘的相应块中。 块接口一个OS必然会提供几种获取到磁盘块的方法，下面有4个示例方法：  readblock(n,p)：将磁盘第n块的字节读到内存的第p页中 writeblo">
<meta property="og:type" content="article">
<meta property="og:title" content="数据库simpleDB入门-1">
<meta property="og:url" content="http://example.com/2021/12/23/%E6%95%B0%E6%8D%AE%E5%BA%93simpleDB%E5%85%A5%E9%97%A8-1/index.html">
<meta property="og:site_name" content="我住8楼">
<meta property="og:description" content="数据存储操作系统磁盘访问接口块级接口块定义磁盘看做成多个连续的块，每个块都有唯一的块号。页是内存中跟块同样大小的区域。 如果一个客户端想要修改一个块中的内容，他必须将这个块先读到页中，然后修改页中的相应字节，然后再将该页写回到磁盘的相应块中。 块接口一个OS必然会提供几种获取到磁盘块的方法，下面有4个示例方法：  readblock(n,p)：将磁盘第n块的字节读到内存的第p页中 writeblo">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2021/12/23/%E6%95%B0%E6%8D%AE%E5%BA%93simpleDB%E5%85%A5%E9%97%A8-1/HeapFile.png">
<meta property="article:published_time" content="2021-12-23T13:57:51.000Z">
<meta property="article:modified_time" content="2021-12-26T13:06:54.544Z">
<meta property="article:author" content="Jason Chao">
<meta property="article:tag" content="database">
<meta property="article:tag" content="simpleDB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2021/12/23/%E6%95%B0%E6%8D%AE%E5%BA%93simpleDB%E5%85%A5%E9%97%A8-1/HeapFile.png">


<link rel="canonical" href="http://example.com/2021/12/23/%E6%95%B0%E6%8D%AE%E5%BA%93simpleDB%E5%85%A5%E9%97%A8-1/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>数据库simpleDB入门-1 | 我住8楼</title><meta name="robots" content="noindex">
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">我住8楼</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="nav-number">1.</span> <span class="nav-text">数据存储</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%A3%81%E7%9B%98%E8%AE%BF%E9%97%AE%E6%8E%A5%E5%8F%A3"><span class="nav-number">1.1.</span> <span class="nav-text">操作系统磁盘访问接口</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9D%97%E7%BA%A7%E6%8E%A5%E5%8F%A3"><span class="nav-number">1.1.1.</span> <span class="nav-text">块级接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9D%97%E5%AE%9A%E4%B9%89"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">块定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9D%97%E6%8E%A5%E5%8F%A3"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">块接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9D%97%E7%AE%A1%E7%90%86%E7%AD%96%E7%95%A5"><span class="nav-number">1.1.1.3.</span> <span class="nav-text">块管理策略</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A3%81%E7%9B%98%E6%98%A0%E5%B0%84"><span class="nav-number">1.1.1.3.1.</span> <span class="nav-text">磁盘映射</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A9%BA%E9%97%B2%E5%88%97%E8%A1%A8"><span class="nav-number">1.1.1.3.2.</span> <span class="nav-text">空闲列表</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%BA%A7%E6%8E%A5%E5%8F%A3"><span class="nav-number">1.1.2.</span> <span class="nav-text">文件级接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9E%E7%BB%AD%E5%88%86%E9%85%8D"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">连续分配</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E6%89%A9%E5%B1%95%E7%9A%84%E5%88%86%E9%85%8D"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">基于扩展的分配</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E5%88%86%E9%85%8D"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">索引分配</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SimpleDB%E7%9A%84%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86%E9%80%89%E6%8B%A9"><span class="nav-number">1.2.</span> <span class="nav-text">SimpleDB的存储管理选择</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9D%97%E7%BA%A7VS%E6%96%87%E4%BB%B6%E7%BA%A7"><span class="nav-number">1.2.1.</span> <span class="nav-text">块级VS文件级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%98%E4%B8%AD%E6%96%B9%E6%A1%88"><span class="nav-number">1.2.2.</span> <span class="nav-text">折中方案</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#lab1"><span class="nav-number">2.</span> <span class="nav-text">lab1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#field-amp-tuple"><span class="nav-number">2.1.</span> <span class="nav-text">field&amp;tuple</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Field"><span class="nav-number">2.1.1.</span> <span class="nav-text">Field</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tuple"><span class="nav-number">2.1.2.</span> <span class="nav-text">Tuple</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TupleDesc"><span class="nav-number">2.1.3.</span> <span class="nav-text">TupleDesc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RecordId"><span class="nav-number">2.1.4.</span> <span class="nav-text">RecordId</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#catalog-amp-DbFile"><span class="nav-number">2.2.</span> <span class="nav-text">catalog&amp;DbFile</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Catalog"><span class="nav-number">2.2.1.</span> <span class="nav-text">Catalog</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DbFile"><span class="nav-number">2.2.2.</span> <span class="nav-text">DbFile</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BufferPool"><span class="nav-number">2.3.</span> <span class="nav-text">BufferPool</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BufferPool-1"><span class="nav-number">2.3.1.</span> <span class="nav-text">BufferPool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Page%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3"><span class="nav-number">2.3.2.</span> <span class="nav-text">Page相关接口</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Operator-SeqScan"><span class="nav-number">2.4.</span> <span class="nav-text">Operator(SeqScan)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DbIterator"><span class="nav-number">2.4.1.</span> <span class="nav-text">DbIterator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SeqScan"><span class="nav-number">2.4.2.</span> <span class="nav-text">SeqScan</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jason Chao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/23/%E6%95%B0%E6%8D%AE%E5%BA%93simpleDB%E5%85%A5%E9%97%A8-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason Chao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我住8楼">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          数据库simpleDB入门-1
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-23 21:57:51" itemprop="dateCreated datePublished" datetime="2021-12-23T21:57:51+08:00">2021-12-23</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-12-26 21:06:54" itemprop="dateModified" datetime="2021-12-26T21:06:54+08:00">2021-12-26</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h1><h2 id="操作系统磁盘访问接口"><a href="#操作系统磁盘访问接口" class="headerlink" title="操作系统磁盘访问接口"></a>操作系统磁盘访问接口</h2><h3 id="块级接口"><a href="#块级接口" class="headerlink" title="块级接口"></a>块级接口</h3><h4 id="块定义"><a href="#块定义" class="headerlink" title="块定义"></a>块定义</h4><p>磁盘看做成多个连续的块，每个块都有唯一的块号。页是内存中跟块同样大小的区域。</p>
<p>如果一个客户端想要修改一个块中的内容，他必须将这个块先读到页中，然后修改页中的相应字节，然后再将该页写回到磁盘的相应块中。</p>
<h4 id="块接口"><a href="#块接口" class="headerlink" title="块接口"></a>块接口</h4><p>一个OS必然会提供几种获取到磁盘块的方法，下面有4个示例方法：</p>
<ul>
<li><code>readblock(n,p)</code>：将磁盘第n块的字节读到内存的第p页中</li>
<li><code>writeblock(n,p)</code>：将内存的第p页的字节写到磁盘第n块中</li>
<li><code>allocate(k,n)</code>：从第n块开始，寻找连续的k个没被使用过的块，并标记为使用过，返回这连续k块的块首的块号。这个块号应该尽量接近n</li>
<li><code>deallocate(k,n)</code>：从第n块开始，将它后续的k块标记为未使用过（包括第n块）</li>
</ul>
<h4 id="块管理策略"><a href="#块管理策略" class="headerlink" title="块管理策略"></a>块管理策略</h4><h5 id="磁盘映射"><a href="#磁盘映射" class="headerlink" title="磁盘映射"></a>磁盘映射</h5><p>一个disk map是一串连续的二进制位，每一位对应磁盘的一个块。1代表块是空闲的，0代码块是被分配了的。这个disk map也是被保存在磁盘中的，通常被保存在一个磁盘的初始几个块中。OS可以简单地通过将disk map相应块的二进制位从0置为1从而取消分配该块；亦可以从第n块开始将连续k位二进制位置为0从而分配连续的k个磁盘块，当然前提是这k块是连续的并且之前的相应二进制都是1.</p>
<h5 id="空闲列表"><a href="#空闲列表" class="headerlink" title="空闲列表"></a>空闲列表</h5><p>一个free list是一连串的<code>块（chunk）</code>，（注意，这里说的块和磁盘的块不一样），chunk是连续的未被分配的blocks，也就是说，chunk是比block更大一点的单位，每个chunk的第一个block存储了两个值：当前chunk的长度，以及下一个chunk首块的block number，你可以将chunk理解为一个单链表的结点。磁盘的第一个block包含了一个指向第一个chunk的指针。当OS被调用，请求分配k个连续的块时，它会搜索free lsit从而获取一个足够大的chunk，然后它可以将这个chunk从free list中分配掉，或者中切出长度为k的块分配掉；当OS被请求取消分配一些块的时候，OS简单地将这些块插入到free list中。</p>
<h3 id="文件级接口"><a href="#文件级接口" class="headerlink" title="文件级接口"></a>文件级接口</h3><p>一个客户端将一个文件看做是一些列字节，在这个级别上，用户不知道块这概念，相反，客户端可以读/写文件任何位置开始的任意长度的字节流。</p>
<p>给定一个特定的文件位置，<code>seek()</code>方法会决定底层实际是哪一块包含了该位置。</p>
<blockquote>
<p>seek() 方法执行两次转换：</p>
<ul>
<li>它会将指定的字节位置转换为一个逻辑块引用</li>
<li>他会将逻辑块引用转换为一个物理块引用</li>
</ul>
</blockquote>
<p>第一个转化相对来说是很简单的——逻辑块号不过就是指定的字节数除以一个块的块大小，举例来说，假设一个块的大小为4K，那么第7992个字节就在第1个块，因为7992/4K=1（整数除法）。</p>
<p>第二个转化就比较难了，而且依赖于当前操作系统下的文件系统是怎么实现的。我们将会看到3种实现方式：<code>连续分配（contiguous allocation）</code>，<code>基于扩展的分配(extent-based allocation）</code>和<code>索引分配(index allocation)</code>。</p>
<h4 id="连续分配"><a href="#连续分配" class="headerlink" title="连续分配"></a>连续分配</h4><p>逻辑块和物理块都是连续的，并记录在文件系统的目录里。</p>
<p>会有两个问题：</p>
<ol>
<li>内部碎片问题：分配的chunk可能未用满，但是也无法分给别的文件用。</li>
<li>外部碎片问题：随着磁盘慢慢变满，它可能会有许多未被分配的小chunk，但又没有大的chunk,因此，即使磁盘有很多的空闲空间，也可能无法创建大文件。</li>
</ol>
<h4 id="基于扩展的分配"><a href="#基于扩展的分配" class="headerlink" title="基于扩展的分配"></a>基于扩展的分配</h4><p>文件不是一次空间分配到位，而是不停的等到用的时候分配一段固定个数块的连续空间，每个文件都记录下这些称之为扩展的块的首块号。</p>
<p>能解决外部碎片问题，内部碎片问题基本也能解决。</p>
<h4 id="索引分配"><a href="#索引分配" class="headerlink" title="索引分配"></a>索引分配</h4><p>每个块单独分配，每个文件记录下所有的被分配给它的文件块号。OS为了实现这种策略，会为每个文件维持一个<code>索引块（index block）</code>，该索引块中保存了这个文件是由那些块组成。也就是说，你可以把索引块中的内容看作是一个整形的数组，<code>ib[N]</code>表示的是第N个逻辑块的实际物理块号。</p>
<h2 id="SimpleDB的存储管理选择"><a href="#SimpleDB的存储管理选择" class="headerlink" title="SimpleDB的存储管理选择"></a>SimpleDB的存储管理选择</h2><h3 id="块级VS文件级"><a href="#块级VS文件级" class="headerlink" title="块级VS文件级"></a>块级VS文件级</h3><p>块级优点：</p>
<ol>
<li>可以更好控制数据分布，提供更高的性能</li>
<li>没有文件大小限制，甚至可以跨磁盘</li>
</ol>
<p>块级缺点：</p>
<ol>
<li>策略实现复杂</li>
</ol>
<p>文件级优点：</p>
<ol>
<li>实现简单</li>
</ol>
<p>文件级缺点：</p>
<ol>
<li>数据库需要知道块的边界，这样能更好的组织和检索数据</li>
<li>数据库需要管理它自己的页，因为操作系统的I/O缓冲区可能会影响到数据库的查询</li>
</ol>
<h3 id="折中方案"><a href="#折中方案" class="headerlink" title="折中方案"></a>折中方案</h3><p>一个折中的办法就是数据库系统将所有的数据存储在一个或多个操作系统文件中，但是把这些文件视为raw disks，也就是说，数据库系统通过使用逻辑文件块来访问它的“磁盘”（其实是文件）。OS负责将每个逻辑文件块引用映射到真实的物理磁盘块中，通过<code>seek()</code>方法。</p>
<h1 id="lab1"><a href="#lab1" class="headerlink" title="lab1"></a>lab1</h1><h2 id="field-amp-tuple"><a href="#field-amp-tuple" class="headerlink" title="field&amp;tuple"></a>field&amp;tuple</h2><h3 id="Field"><a href="#Field" class="headerlink" title="Field"></a>Field</h3><p>主要是要记录列的类型和值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Interface for values of fields in tuples in SimpleDB.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Field</span> <span class="keyword">extends</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Write the bytes representing this field to the specified</span></span><br><span class="line"><span class="comment">     * DataOutputStream.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> DataOutputStream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dos The DataOutputStream to write to.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">serialize</span><span class="params">(DataOutputStream dos)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Compare the value of this field object to the passed in value.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> op The operator</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value The value to compare this Field to</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Whether or not the comparison yields true.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">compare</span><span class="params">(Predicate.Op op, Field value)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the type of this field (see &#123;<span class="doctag">@link</span> Type#INT_TYPE&#125; or &#123;<span class="doctag">@link</span> Type#STRING_TYPE&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> type of this field</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Type <span class="title">getType</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Hash code.</span></span><br><span class="line"><span class="comment">     * Different Field objects representing the same value should probably</span></span><br><span class="line"><span class="comment">     * return the same hashCode.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object field)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="Tuple"><a href="#Tuple" class="headerlink" title="Tuple"></a>Tuple</h3><p> 相当于一行数据，有三个重要成员：</p>
<ol>
<li>tupleDesc，记录这个元组对应的元数据</li>
<li>RecordId, 行主键</li>
<li>所有列值</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tuple maintains information about the contents of a tuple. Tuples have a</span></span><br><span class="line"><span class="comment"> * specified schema specified by a TupleDesc object and contain Field objects</span></span><br><span class="line"><span class="comment"> * with the data for each field.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tuple</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(Tuple.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TupleDesc tupleDesc;</span><br><span class="line">    <span class="keyword">private</span> RecordId recordId = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Field&gt; fieldList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new tuple with the specified schema (type).</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> td</span></span><br><span class="line"><span class="comment">     *            the schema of this tuple. It must be a valid TupleDesc</span></span><br><span class="line"><span class="comment">     *            instance with at least one field.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Tuple</span><span class="params">(TupleDesc td)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        tupleDesc = td;</span><br><span class="line">        fieldList = <span class="keyword">new</span> ArrayList&lt;&gt;(td.numFields());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; td.numFields(); i++) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (td.getFieldType(i)) &#123;</span><br><span class="line">                <span class="keyword">case</span> INT_TYPE:</span><br><span class="line">                    fieldList.add(<span class="keyword">new</span> IntField(-<span class="number">1</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> STRING_TYPE:</span><br><span class="line">                    fieldList.add(<span class="keyword">new</span> StringField(<span class="string">&quot;&quot;</span>, Type.STRING_TYPE.getLen()));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    logger.error(<span class="string">&quot;unsupport type &#123;&#125;&quot;</span>, td.getFieldType(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="TupleDesc"><a href="#TupleDesc" class="headerlink" title="TupleDesc"></a>TupleDesc</h3><p>元组的描述，可以理解为表中列的定义。</p>
<ol>
<li>主要是列类型和列名字</li>
<li>提供一些获取和遍历列定义的方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TupleDesc describes the schema of a tuple.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TupleDesc</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(TupleDesc.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Type&gt; types;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; names;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> modCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A help class to facilitate organizing the information of each field</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TDItem</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The type of the field</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        Type fieldType;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The name of the field</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        String fieldName;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TDItem</span><span class="params">(Type t, String n)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.fieldName = n;</span><br><span class="line">            <span class="keyword">this</span>.fieldType = t;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> fieldName + <span class="string">&quot;(&quot;</span> + fieldType + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     *        An iterator which iterates over all the field TDItems</span></span><br><span class="line"><span class="comment">     *        that are included in this TupleDesc</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator&lt;TDItem&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TupleDescIterator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new TupleDesc with typeAr.length fields with fields of the</span></span><br><span class="line"><span class="comment">     * specified types, with associated named fields.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> typeAr</span></span><br><span class="line"><span class="comment">     *            array specifying the number of and types of fields in this</span></span><br><span class="line"><span class="comment">     *            TupleDesc. It must contain at least one entry.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fieldAr</span></span><br><span class="line"><span class="comment">     *            array specifying the names of the fields. Note that names may</span></span><br><span class="line"><span class="comment">     *            be null.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TupleDesc</span><span class="params">(Type[] typeAr, String[] fieldAr)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        types = Arrays.asList(typeAr);</span><br><span class="line">        names = Arrays.asList(fieldAr);</span><br><span class="line">        modCount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructor. Create a new tuple desc with typeAr.length fields with</span></span><br><span class="line"><span class="comment">     * fields of the specified types, with anonymous (unnamed) fields.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> typeAr</span></span><br><span class="line"><span class="comment">     *            array specifying the number of and types of fields in this</span></span><br><span class="line"><span class="comment">     *            TupleDesc. It must contain at least one entry.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TupleDesc</span><span class="params">(Type[] typeAr)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        types = Arrays.asList(typeAr);</span><br><span class="line">        names = <span class="keyword">new</span> ArrayList&lt;&gt;(typeAr.length);</span><br><span class="line">        modCount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the (possibly null) field name of the ith field of this TupleDesc.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> i</span></span><br><span class="line"><span class="comment">     *            index of the field name to return. It must be a valid index.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the name of the ith field</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchElementException</span></span><br><span class="line"><span class="comment">     *             if i is not a valid field reference.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFieldName</span><span class="params">(<span class="keyword">int</span> i)</span> <span class="keyword">throws</span> NoSuchElementException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the type of the ith field of this TupleDesc.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> i</span></span><br><span class="line"><span class="comment">     *            The index of the field to get the type of. It must be a valid</span></span><br><span class="line"><span class="comment">     *            index.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the type of the ith field</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchElementException</span></span><br><span class="line"><span class="comment">     *             if i is not a valid field reference.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Type <span class="title">getFieldType</span><span class="params">(<span class="keyword">int</span> i)</span> <span class="keyword">throws</span> NoSuchElementException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Find the index of the field with a given name.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     *            name of the field.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the index of the field that is first to have the given name.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchElementException</span></span><br><span class="line"><span class="comment">     *             if no field with a matching name is found.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">fieldNameToIndex</span><span class="params">(String name)</span> <span class="keyword">throws</span> NoSuchElementException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The size (in bytes) of tuples corresponding to this TupleDesc.</span></span><br><span class="line"><span class="comment">     *         Note that tuples from a given TupleDesc are of a fixed size.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Merge two TupleDescs into one, with td1.numFields + td2.numFields fields,</span></span><br><span class="line"><span class="comment">     * with the first td1.numFields coming from td1 and the remaining from td2.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> td1</span></span><br><span class="line"><span class="comment">     *            The TupleDesc with the first fields of the new TupleDesc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> td2</span></span><br><span class="line"><span class="comment">     *            The TupleDesc with the last fields of the TupleDesc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the new TupleDesc</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TupleDesc <span class="title">merge</span><span class="params">(TupleDesc td1, TupleDesc td2)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        List&lt;Type&gt; types = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        List&lt;String&gt; names = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        types.addAll(td1.getTypes());</span><br><span class="line">        types.addAll(td2.getTypes());</span><br><span class="line">        names.addAll(td1.getNames());</span><br><span class="line">        names.addAll(td2.getNames());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TupleDesc(types.toArray(<span class="keyword">new</span> Type[<span class="number">0</span>]), names.toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TupleDescIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">TDItem</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> curIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> lastRet = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> expectedModCount = modCount;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> curIndex &lt; types.size();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> TDItem <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            checkForComodification();</span><br><span class="line">            <span class="keyword">if</span> (curIndex &gt;= types.size()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException(<span class="string">&quot;no more element.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            lastRet = curIndex;</span><br><span class="line">            TDItem item = <span class="keyword">new</span> TDItem(types.get(curIndex), names.get(curIndex));</span><br><span class="line">            curIndex++;</span><br><span class="line">            <span class="keyword">return</span> item;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (lastRet &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">            checkForComodification();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                types.remove(lastRet);</span><br><span class="line">                names.remove(lastRet);</span><br><span class="line">                modCount++;</span><br><span class="line">                curIndex = lastRet;</span><br><span class="line">                lastRet = -<span class="number">1</span>;</span><br><span class="line">                expectedModCount = modCount;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IndexOutOfBoundsException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">checkForComodification</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="RecordId"><a href="#RecordId" class="headerlink" title="RecordId"></a>RecordId</h3><p>记录在表文件中唯一的主键。有两个字段：</p>
<ol>
<li>PageId</li>
<li>TupleNo</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A RecordId is a reference to a specific tuple on a specific page of a</span></span><br><span class="line"><span class="comment"> * specific table.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecordId</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> PageId pageId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tupleNo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new RecordId referring to the specified PageId and tuple</span></span><br><span class="line"><span class="comment">     * number.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pid</span></span><br><span class="line"><span class="comment">     *            the pageid of the page on which the tuple resides</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tupleno</span></span><br><span class="line"><span class="comment">     *            the tuple number within the page.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RecordId</span><span class="params">(PageId pid, <span class="keyword">int</span> tupleno)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        pageId = pid;</span><br><span class="line">        tupleNo = tupleno;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里需要说明下SimpleDB这个实验里数据是怎么存储的了。</p>
<p>如下图所示：</p>
<ol>
<li><p>每张表都是一个文件，在内存中对应的对象是HeapFile，当前SimpleDB只支持固定大小的表定义，即每次定义表后，它的每行所占空间固定了，不支持每行数据变长存储。</p>
</li>
<li><p>每个HeapFile都会被划分为多个固定为4K大小的HeapPage，不支持数据跨页存储。</p>
</li>
<li><p>每个HeapPage则会被划分为固定大小的slot，而slot的大小则跟表的定义有关系，即为每个tuple的大小</p>
</li>
<li><p>在HeapPage里，需要将slot分配给不同的tuple数据，因此需要来管理每个slot是否分配信息。这个是通过一个bitmap来实现的，即下图中的Header，header是每个Page的前几个slot。每个slot的每个bit都分别指示对应的slot是否被分配。</p>
</li>
<li><p>计算一个页能存放几个slot可以通过以下公式来计算<br>$$<br>TuplePerPage=floor(\frac{BufferPool.PAGE_SIZE * 8}{tupleSize * 8 + 1})<br>$$</p>
</li>
<li><p>而计算Header占多少个字节，则通过以下公式来计算<br>$$<br>headerByte=ceiling(\frac{tuplePerPage}{8})<br>$$</p>
</li>
<li><p>header之后马上是Tuple，Page末尾会有0填充用不上的空间<br>$$<br>TuplePerPage=floor(\frac{BufferPool.PAGE_SIZE * 8}{tupleSize * 8 + 1})<br>$$</p>
</li>
</ol>
<img src="/2021/12/23/%E6%95%B0%E6%8D%AE%E5%BA%93simpleDB%E5%85%A5%E9%97%A8-1/HeapFile.png" class="" title="HeapFile">

<h2 id="catalog-amp-DbFile"><a href="#catalog-amp-DbFile" class="headerlink" title="catalog&amp;DbFile"></a>catalog&amp;DbFile</h2><p>catalog是数据库里所有表元数据的管理者，主要负责：</p>
<ol>
<li>元数据持久化和加载</li>
<li>管理表元数据：<ol>
<li>表的唯一Id和表的名字，以及对应关系</li>
<li>表对应的文件</li>
</ol>
</li>
</ol>
<h3 id="Catalog"><a href="#Catalog" class="headerlink" title="Catalog"></a>Catalog</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Catalog keeps track of all available tables in the database and their</span></span><br><span class="line"><span class="comment"> * associated schemas.</span></span><br><span class="line"><span class="comment"> * For now, this is a stub catalog that must be populated with tables by a</span></span><br><span class="line"><span class="comment"> * user program before it can be used -- eventually, this should be converted</span></span><br><span class="line"><span class="comment"> * to a catalog that reads a catalog table from disk.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Catalog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer, TableInfo&gt; tableIds;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Integer&gt; tableNames;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String catalogFile = <span class="string">&quot;schema&quot;</span>;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add a new table to the catalog.</span></span><br><span class="line"><span class="comment">     * This table&#x27;s contents are stored in the specified DbFile.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file the contents of the table to add;  file.getId() is the identfier of</span></span><br><span class="line"><span class="comment">     *    this file/tupledesc param for the calls getTupleDesc and getFile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name the name of the table -- may be an empty string.  May not be null.  If a name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pkeyField the name of the primary key field</span></span><br><span class="line"><span class="comment">     * conflict exists, use the last table to be added as the table for a given name.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTable</span><span class="params">(DbFile file, String name, String pkeyField)</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTable</span><span class="params">(DbFile file, String name)</span> </span>&#123;</span><br><span class="line">        addTable(file, name, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add a new table to the catalog.</span></span><br><span class="line"><span class="comment">     * This table has tuples formatted using the specified TupleDesc and its</span></span><br><span class="line"><span class="comment">     * contents are stored in the specified DbFile.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file the contents of the table to add;  file.getId() is the identfier of</span></span><br><span class="line"><span class="comment">     *    this file/tupledesc param for the calls getTupleDesc and getFile</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTable</span><span class="params">(DbFile file)</span> </span>&#123;</span><br><span class="line">        addTable(file, (UUID.randomUUID()).toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the id of the table with a specified name,</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchElementException if the table doesn&#x27;t exist</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTableId</span><span class="params">(String name)</span> <span class="keyword">throws</span> NoSuchElementException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the tuple descriptor (schema) of the specified table</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableid The id of the table, as specified by the DbFile.getId()</span></span><br><span class="line"><span class="comment">     *     function passed to addTable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchElementException if the table doesn&#x27;t exist</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TupleDesc <span class="title">getTupleDesc</span><span class="params">(<span class="keyword">int</span> tableid)</span> <span class="keyword">throws</span> NoSuchElementException </span>&#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the DbFile that can be used to read the contents of the</span></span><br><span class="line"><span class="comment">     * specified table.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableid The id of the table, as specified by the DbFile.getId()</span></span><br><span class="line"><span class="comment">     *     function passed to addTable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DbFile <span class="title">getDbFile</span><span class="params">(<span class="keyword">int</span> tableid)</span> <span class="keyword">throws</span> NoSuchElementException </span>&#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPrimaryKey</span><span class="params">(<span class="keyword">int</span> tableid)</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator&lt;Integer&gt; <span class="title">tableIdIterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTableName</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reads the schema from a file and creates the appropriate tables in the database.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> catalogFile</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadSchema</span><span class="params">(String catalogFile)</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TableInfo</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> DbFile file;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> String pkeyField;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="DbFile"><a href="#DbFile" class="headerlink" title="DbFile"></a>DbFile</h3><p>表文件的封装，主要提供页的读写，tuple的读写删接口：</p>
<ol>
<li>readPage</li>
<li>writePage</li>
<li>InsertTuple</li>
<li>DeleteTuple</li>
<li>iterator</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The interface for database files on disk. Each table is represented by a</span></span><br><span class="line"><span class="comment"> * single DbFile. DbFiles can fetch pages and iterate through tuples. Each</span></span><br><span class="line"><span class="comment"> * file has a unique id used to store metadata about the table in the Catalog.</span></span><br><span class="line"><span class="comment"> * DbFiles are generally accessed through the buffer pool, rather than directly</span></span><br><span class="line"><span class="comment"> * by operators.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DbFile</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Read the specified page from disk.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if the page does not exist in this file.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page <span class="title">readPage</span><span class="params">(PageId id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Push the specified page to disk.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p The page to write.  page.getId().pageno() specifies the offset into the file where the page should be written.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException if the write fails</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writePage</span><span class="params">(Page p)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Inserts the specified tuple to the file on behalf of transaction.</span></span><br><span class="line"><span class="comment">     * This method will acquire a lock on the affected pages of the file, and</span></span><br><span class="line"><span class="comment">     * may block until the lock can be acquired.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid The transaction performing the update</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t The tuple to add.  This tuple should be updated to reflect that</span></span><br><span class="line"><span class="comment">     *          it is now stored in this file.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> An ArrayList contain the pages that were modified</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> DbException if the tuple cannot be added</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException if the needed file can&#x27;t be read/written</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ArrayList&lt;Page&gt; <span class="title">insertTuple</span><span class="params">(TransactionId tid, Tuple t)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> DbException, IOException, TransactionAbortedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Removes the specifed tuple from the file on behalf of the specified</span></span><br><span class="line"><span class="comment">     * transaction.</span></span><br><span class="line"><span class="comment">     * This method will acquire a lock on the affected pages of the file, and</span></span><br><span class="line"><span class="comment">     * may block until the lock can be acquired.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> DbException if the tuple cannot be deleted or is not a member</span></span><br><span class="line"><span class="comment">     *   of the file</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page <span class="title">deleteTuple</span><span class="params">(TransactionId tid, Tuple t)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> DbException, TransactionAbortedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an iterator over all the tuples stored in this DbFile. The</span></span><br><span class="line"><span class="comment">     * iterator must use &#123;<span class="doctag">@link</span> BufferPool#getPage&#125;, rather than</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #readPage&#125; to iterate through the pages.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> an iterator over all the tuples stored in this DbFile.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DbFileIterator <span class="title">iterator</span><span class="params">(TransactionId tid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a unique ID used to identify this DbFile in the Catalog. This id</span></span><br><span class="line"><span class="comment">     * can be used to look up the table via &#123;<span class="doctag">@link</span> Catalog#getDbFile&#125; and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> Catalog#getTupleDesc&#125;.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Implementation note:  you will need to generate this tableid somewhere,</span></span><br><span class="line"><span class="comment">     * ensure that each HeapFile has a &quot;unique id,&quot; and that you always</span></span><br><span class="line"><span class="comment">     * return the same value for a particular HeapFile. A simple implementation</span></span><br><span class="line"><span class="comment">     * is to use the hash code of the absolute path of the file underlying</span></span><br><span class="line"><span class="comment">     * the HeapFile, i.e. &lt;code&gt;f.getAbsoluteFile().hashCode()&lt;/code&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> an ID uniquely identifying this HeapFile.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the TupleDesc of the table stored in this DbFile.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> TupleDesc of this DbFile.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TupleDesc <span class="title">getTupleDesc</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="BufferPool"><a href="#BufferPool" class="headerlink" title="BufferPool"></a>BufferPool</h2><h3 id="BufferPool-1"><a href="#BufferPool-1" class="headerlink" title="BufferPool"></a>BufferPool</h3><p>固定大小缓存池，使用一个map来记录缓存在内存中的页内容。</p>
<p>提供页读写和页管理的接口：</p>
<ol>
<li>getPage</li>
<li>releasePage</li>
<li>flushPage</li>
<li>evictPage</li>
</ol>
<p>提供事务处理相关的接口，方便实现事务管理：</p>
<ol>
<li>transactionComplete</li>
<li>holdLocks</li>
</ol>
<p>提供元组处理相关的接口</p>
<ol>
<li>insertTuple</li>
<li>deleteTuple</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BufferPool manages the reading and writing of pages into memory from</span></span><br><span class="line"><span class="comment"> * disk. Access methods call into it to retrieve pages, and it fetches</span></span><br><span class="line"><span class="comment"> * pages from the appropriate location.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * The BufferPool is also responsible for locking;  when a transaction fetches</span></span><br><span class="line"><span class="comment"> * a page, BufferPool checks that the transaction has the appropriate</span></span><br><span class="line"><span class="comment"> * locks to read/write the page.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferPool</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** Bytes per page, including header. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PAGE_SIZE = <span class="number">4096</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Default number of pages passed to the constructor. This is used by</span></span><br><span class="line"><span class="comment">    other classes. BufferPool should use the numPages argument to the</span></span><br><span class="line"><span class="comment">    constructor instead. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PAGES = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;PageId, Page&gt; pages;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> numPages;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a BufferPool that caches up to numPages pages.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> numPages maximum number of pages in this buffer pool.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BufferPool</span><span class="params">(<span class="keyword">int</span> numPages)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        pages = <span class="keyword">new</span> HashMap&lt;&gt;(numPages);</span><br><span class="line">        <span class="keyword">this</span>.numPages = numPages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Retrieve the specified page with the associated permissions.</span></span><br><span class="line"><span class="comment">     * Will acquire a lock and may block if that lock is held by another</span></span><br><span class="line"><span class="comment">     * transaction.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * The retrieved page should be looked up in the buffer pool.  If it</span></span><br><span class="line"><span class="comment">     * is present, it should be returned.  If it is not present, it should</span></span><br><span class="line"><span class="comment">     * be added to the buffer pool and returned.  If there is insufficient</span></span><br><span class="line"><span class="comment">     * space in the buffer pool, an page should be evicted and the new page</span></span><br><span class="line"><span class="comment">     * should be added in its place.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid the ID of the transaction requesting the page</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pid the ID of the requested page</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> perm the requested permissions on the page</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  Page <span class="title">getPage</span><span class="params">(TransactionId tid, PageId pid, Permissions perm)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TransactionAbortedException, DbException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">if</span> (pages.containsKey(pid)) &#123;</span><br><span class="line">            <span class="keyword">return</span> pages.get(pid);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pages.size() &gt;= numPages)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> DbException(<span class="string">&quot;no more pages&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Page cur = Database.getCatalog().getDbFile(pid.getTableId()).readPage(pid);</span><br><span class="line">        pages.putIfAbsent(pid, cur);</span><br><span class="line">        <span class="keyword">return</span> cur;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Releases the lock on a page.</span></span><br><span class="line"><span class="comment">     * Calling this is very risky, and may result in wrong behavior. Think hard</span></span><br><span class="line"><span class="comment">     * about who needs to call this and why, and why they can run the risk of</span></span><br><span class="line"><span class="comment">     * calling it.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid the ID of the transaction requesting the unlock</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pid the ID of the page to unlock</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">releasePage</span><span class="params">(TransactionId tid, PageId pid)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for proj1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Release all locks associated with a given transaction.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid the ID of the transaction requesting the unlock</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transactionComplete</span><span class="params">(TransactionId tid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for proj1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Return true if the specified transaction has a lock on the specified page */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">holdsLock</span><span class="params">(TransactionId tid, PageId p)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for proj1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Commit or abort a given transaction; release all locks associated to</span></span><br><span class="line"><span class="comment">     * the transaction.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid the ID of the transaction requesting the unlock</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commit a flag indicating whether we should commit or abort</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transactionComplete</span><span class="params">(TransactionId tid, <span class="keyword">boolean</span> commit)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for proj1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add a tuple to the specified table behalf of transaction tid.  Will</span></span><br><span class="line"><span class="comment">     * acquire a write lock on the page the tuple is added to(Lock </span></span><br><span class="line"><span class="comment">     * acquisition is not needed for lab2). May block if the lock cannot </span></span><br><span class="line"><span class="comment">     * be acquired.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * Marks any pages that were dirtied by the operation as dirty by calling</span></span><br><span class="line"><span class="comment">     * their markDirty bit, and updates cached versions of any pages that have </span></span><br><span class="line"><span class="comment">     * been dirtied so that future requests see up-to-date pages. </span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid the transaction adding the tuple</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableId the table to add the tuple to</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the tuple to add</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertTuple</span><span class="params">(TransactionId tid, <span class="keyword">int</span> tableId, Tuple t)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> DbException, IOException, TransactionAbortedException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for proj1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Remove the specified tuple from the buffer pool.</span></span><br><span class="line"><span class="comment">     * Will acquire a write lock on the page the tuple is removed from. May block if</span></span><br><span class="line"><span class="comment">     * the lock cannot be acquired.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Marks any pages that were dirtied by the operation as dirty by calling</span></span><br><span class="line"><span class="comment">     * their markDirty bit.  Does not need to update cached versions of any pages that have </span></span><br><span class="line"><span class="comment">     * been dirtied, as it is not possible that a new page was created during the deletion</span></span><br><span class="line"><span class="comment">     * (note difference from addTuple).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid the transaction adding the tuple.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the tuple to add</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">deleteTuple</span><span class="params">(TransactionId tid, Tuple t)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> DbException, TransactionAbortedException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for proj1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Flush all dirty pages to disk.</span></span><br><span class="line"><span class="comment">     * NB: Be careful using this routine -- it writes dirty data to disk so will</span></span><br><span class="line"><span class="comment">     *     break simpledb if running in NO STEAL mode.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">flushAllPages</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for proj1</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Remove the specific page id from the buffer pool.</span></span><br><span class="line"><span class="comment">        Needed by the recovery manager to ensure that the</span></span><br><span class="line"><span class="comment">        buffer pool doesn&#x27;t keep a rolled back page in its</span></span><br><span class="line"><span class="comment">        cache.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">discardPage</span><span class="params">(PageId pid)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">	<span class="comment">// not necessary for proj1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Flushes a certain page to disk</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pid an ID indicating the page to flush</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span>  <span class="keyword">void</span> <span class="title">flushPage</span><span class="params">(PageId pid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for proj1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Write all pages of the specified transaction to disk.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span>  <span class="keyword">void</span> <span class="title">flushPages</span><span class="params">(TransactionId tid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for proj1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Discards a page from the buffer pool.</span></span><br><span class="line"><span class="comment">     * Flushes the page to disk to ensure dirty pages are updated on disk.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span>  <span class="keyword">void</span> <span class="title">evictPage</span><span class="params">()</span> <span class="keyword">throws</span> DbException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for proj1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Page相关接口"><a href="#Page相关接口" class="headerlink" title="Page相关接口"></a>Page相关接口</h3><ol>
<li>获取Id</li>
<li>标志是否被修改（dirty）</li>
<li>获取当前页内容</li>
<li>获取修改之前的页内容，用来进行事务回滚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Page is the interface used to represent pages that are resident in the</span></span><br><span class="line"><span class="comment"> * BufferPool.  Typically, DbFiles will read and write pages from disk.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Pages may be &quot;dirty&quot;, indicating that they have been modified since they</span></span><br><span class="line"><span class="comment"> * were last written out to disk.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For recovery purposes, pages MUST have a single constructor of the form:</span></span><br><span class="line"><span class="comment"> *     Page(PageId id, byte[] data)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Page</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the id of this page.  The id is a unique identifier for a page</span></span><br><span class="line"><span class="comment">     * that can be used to look up the page on disk or determine if the page</span></span><br><span class="line"><span class="comment">     * is resident in the buffer pool.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the id of this page</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PageId <span class="title">getId</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the id of the transaction that last dirtied this page, or null if the page is clean..</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The id of the transaction that last dirtied this page, or null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TransactionId <span class="title">isDirty</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Set the dirty state of this page as dirtied by a particular transaction</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">markDirty</span><span class="params">(<span class="keyword">boolean</span> dirty, TransactionId tid)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Generates a byte array representing the contents of this page.</span></span><br><span class="line"><span class="comment">   * Used to serialize this page to disk.</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * The invariant here is that it should be possible to pass the byte array</span></span><br><span class="line"><span class="comment">   * generated by getPageData to the Page constructor and have it produce</span></span><br><span class="line"><span class="comment">   * an identical Page object.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> A byte array correspond to the bytes of this page.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getPageData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Provide a representation of this page before any modifications were made</span></span><br><span class="line"><span class="comment">        to it.  Used by recovery.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page <span class="title">getBeforeImage</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * a transaction that wrote this page just committed it.</span></span><br><span class="line"><span class="comment">     * copy current content to the before image.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeforeImage</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Operator-SeqScan"><a href="#Operator-SeqScan" class="headerlink" title="Operator(SeqScan)"></a>Operator(SeqScan)</h2><h3 id="DbIterator"><a href="#DbIterator" class="headerlink" title="DbIterator"></a>DbIterator</h3><p>数据库迭代器，所有的算子都需要实现这个接口，主要是提供通用的几个接口：</p>
<ol>
<li>open</li>
<li>close</li>
<li>hasNext</li>
<li>next</li>
<li>rewind：重置读取游标，可以从头开始读取数据</li>
<li>getTupleDesc</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DbIterator is the iterator interface that all SimpleDB operators should</span></span><br><span class="line"><span class="comment"> * implement. If the iterator is not open, none of the methods should work,</span></span><br><span class="line"><span class="comment"> * and should throw an IllegalStateException.  In addition to any</span></span><br><span class="line"><span class="comment"> * resource allocation/deallocation, an open method should call any</span></span><br><span class="line"><span class="comment"> * child iterator open methods, and in a close method, an iterator</span></span><br><span class="line"><span class="comment"> * should call its children&#x27;s close methods.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DbIterator</span> <span class="keyword">extends</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Opens the iterator. This must be called before any of the other methods.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> DbException when there are problems opening/accessing the database.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">()</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> DbException, TransactionAbortedException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Returns true if the iterator has more tuples.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> true f the iterator has more tuples.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> IllegalStateException If the iterator has not been opened</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> <span class="keyword">throws</span> DbException, TransactionAbortedException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns the next tuple from the operator (typically implementing by reading</span></span><br><span class="line"><span class="comment">   * from a child operator or an access method).</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> the next tuple in the iteration.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> NoSuchElementException if there are no more tuples.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> IllegalStateException If the iterator has not been opened</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Tuple <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> DbException, TransactionAbortedException, NoSuchElementException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Resets the iterator to the start.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> DbException when rewind is unsupported.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> IllegalStateException If the iterator has not been opened</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rewind</span><span class="params">()</span> <span class="keyword">throws</span> DbException, TransactionAbortedException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns the TupleDesc associated with this DbIterator. </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> the TupleDesc associated with this DbIterator.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> TupleDesc <span class="title">getTupleDesc</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Closes the iterator. When the iterator is closed, calling next(),</span></span><br><span class="line"><span class="comment">   * hasNext(), or rewind() should fail by throwing IllegalStateException.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="SeqScan"><a href="#SeqScan" class="headerlink" title="SeqScan"></a>SeqScan</h3><p>数据扫描算子，提供扫描指定表的所有数据功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SeqScan is an implementation of a sequential scan access method that reads</span></span><br><span class="line"><span class="comment"> * each tuple of a table in no particular order (e.g., as they are laid out on</span></span><br><span class="line"><span class="comment"> * disk).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeqScan</span> <span class="keyword">implements</span> <span class="title">DbIterator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> TransactionId tid;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tableId;</span><br><span class="line">    <span class="keyword">private</span> String tableAlias;</span><br><span class="line">    <span class="keyword">private</span> DbFileIterator fileIterator = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a sequential scan over the specified table as a part of the</span></span><br><span class="line"><span class="comment">     * specified transaction.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid</span></span><br><span class="line"><span class="comment">     *            The transaction this scan is running as a part of.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableid</span></span><br><span class="line"><span class="comment">     *            the table to scan.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableAlias</span></span><br><span class="line"><span class="comment">     *            the alias of this table (needed by the parser); the returned</span></span><br><span class="line"><span class="comment">     *            tupleDesc should have fields with name tableAlias.fieldName</span></span><br><span class="line"><span class="comment">     *            (note: this class is not responsible for handling a case where</span></span><br><span class="line"><span class="comment">     *            tableAlias or fieldName are null. It shouldn&#x27;t crash if they</span></span><br><span class="line"><span class="comment">     *            are, but the resulting name can be null.fieldName,</span></span><br><span class="line"><span class="comment">     *            tableAlias.null, or null.null).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeqScan</span><span class="params">(TransactionId tid, <span class="keyword">int</span> tableid, String tableAlias)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">this</span>.tid = tid;</span><br><span class="line">        <span class="keyword">this</span>.tableId = tableid;</span><br><span class="line">        <span class="keyword">this</span>.tableAlias = tableAlias;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     *       return the table name of the table the operator scans. This should</span></span><br><span class="line"><span class="comment">     *       be the actual name of the table in the catalog of the database</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTableName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Database.getCatalog().getTableName(tableId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Return the alias of the table this operator scans. </span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAlias</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> tableAlias;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reset the tableid, and tableAlias of this operator.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableid</span></span><br><span class="line"><span class="comment">     *            the table to scan.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableAlias</span></span><br><span class="line"><span class="comment">     *            the alias of this table (needed by the parser); the returned</span></span><br><span class="line"><span class="comment">     *            tupleDesc should have fields with name tableAlias.fieldName</span></span><br><span class="line"><span class="comment">     *            (note: this class is not responsible for handling a case where</span></span><br><span class="line"><span class="comment">     *            tableAlias or fieldName are null. It shouldn&#x27;t crash if they</span></span><br><span class="line"><span class="comment">     *            are, but the resulting name can be null.fieldName,</span></span><br><span class="line"><span class="comment">     *            tableAlias.null, or null.null).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">(<span class="keyword">int</span> tableid, String tableAlias)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">this</span>.tableId = tableid;</span><br><span class="line">        <span class="keyword">this</span>.tableAlias = tableAlias;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeqScan</span><span class="params">(TransactionId tid, <span class="keyword">int</span> tableid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(tid, tableid, Database.getCatalog().getTableName(tableid));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">()</span> <span class="keyword">throws</span> DbException, TransactionAbortedException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        fileIterator = Database.getCatalog().getDbFile(tableId).iterator(tid);</span><br><span class="line">        fileIterator.open();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the TupleDesc with field names from the underlying HeapFile,</span></span><br><span class="line"><span class="comment">     * prefixed with the tableAlias string from the constructor. This prefix</span></span><br><span class="line"><span class="comment">     * becomes useful when joining tables containing a field(s) with the same</span></span><br><span class="line"><span class="comment">     * name.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the TupleDesc with field names from the underlying HeapFile,</span></span><br><span class="line"><span class="comment">     *         prefixed with the tableAlias string from the constructor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TupleDesc <span class="title">getTupleDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> Database.getCatalog().getTupleDesc(tableId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> <span class="keyword">throws</span> TransactionAbortedException, DbException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> fileIterator.hasNext();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Tuple <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchElementException,</span></span><br><span class="line"><span class="function">            TransactionAbortedException, DbException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> fileIterator.next();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        fileIterator.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rewind</span><span class="params">()</span> <span class="keyword">throws</span> DbException, NoSuchElementException,</span></span><br><span class="line"><span class="function">            TransactionAbortedException </span>&#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        fileIterator.rewind();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>整体来说存储这块本次作业是比较简单的，做了以下几个设计：</p>
<ol>
<li>数据以文件的方式存储，使用的是文件系统提供的能力，这样不用去考虑磁盘中块的组织，简化了设计实现</li>
<li>每个文件都被划分为固定大小的页，不支持数据跨页存储</li>
<li>仅支持固定大小的元组</li>
<li>因此，很自然的每个页内也会被划分为固定大小的slot，每个slot跟一个tuple的大小一致</li>
<li>为了管理slot，采用的是磁盘映射（位图法）来记录每个slot的分配情况</li>
<li>使用一个全局的缓存池来以页为单位读写数据，方便进行数据缓存复用</li>
<li>定义统一的算子接口，以tuple为单位在各个算子之间进行数据流通</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://929910266.gitbook.io/simpledb/part3/ch12">https://sites.google.com/site/cs186fall2013/homeworks/project-1</a></li>
<li><a target="_blank" rel="noopener" href="https://929910266.gitbook.io/simpledb/part3/ch12">磁盘及文件管理</a></li>
</ol>
<!-- flag of hidden posts -->
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/database/" rel="tag"># database</a>
              <a href="/tags/simpleDB/" rel="tag"># simpleDB</a>
          </div>

        

    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2021 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason Chao</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
