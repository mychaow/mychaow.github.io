<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","version":"8.2.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta property="og:type" content="website">
<meta property="og:title" content="我住8楼">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="我住8楼">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Jason Chao">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>
<title>我住8楼</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">我住8楼</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jason Chao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/01/%E6%95%B0%E6%8D%AE%E5%BA%93simpleDB%E5%85%A5%E9%97%A8-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason Chao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我住8楼">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/01/%E6%95%B0%E6%8D%AE%E5%BA%93simpleDB%E5%85%A5%E9%97%A8-3/" class="post-title-link" itemprop="url">数据库simpleDB入门-3</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-01 22:41:14" itemprop="dateCreated datePublished" datetime="2022-01-01T22:41:14+08:00">2022-01-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/11/01/duckDB%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason Chao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我住8楼">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/01/duckDB%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">duckDB内存管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-11-01 14:03:29 / 修改时间：16:41:15" itemprop="dateCreated datePublished" datetime="2021-11-01T14:03:29+08:00">2021-11-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>DuckDB 是一款嵌入式列式数据库，主要用于嵌入其他程序执行快速的 SQL 分析查询，官方称其为“分析型数据库中的 SQLite”。DuckDB 易于安装和使用，没有外部依赖，同时提供了 C/C++、Python 以及 R 的语言绑定。</p>
<p>DuckDB 由荷兰 Centrum Wiskunde &amp; Informatica 的数据库架构组开发，他们还开发了 MonetDB（一款开源的列式存储数据库）。DuckDB 采用 MIT 开源协议，并且在 GitHub 上开放了源代码。DuckDB 于 2019 年 6 月 27日首次发布了官方的 0.1 发布版。</p>
<h1 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h1><p>duckDB有一套内存管理模式，基于自己的文件组织结构来做的。</p>
<p>主要涉及的类有：</p>
<ol>
<li>BufferManager<ol>
<li>内存池对外接口，提供内存管理的方法</li>
</ol>
</li>
<li>BlockManager<ol>
<li>块管理器，目前有一个实现是single_file_block_manager</li>
<li>DuckDB的一个数据库就有一个BlockManager进行管理</li>
</ol>
</li>
<li>Filebuffer<ol>
<li>内存缓存块，不一定是固定大小</li>
</ol>
</li>
<li>Block<ol>
<li>继承FileBuffer，固定大小，是块抽象，默认256KB大小</li>
<li>DuckDB认为磁盘sector大小是4KB</li>
</ol>
</li>
</ol>
<h2 id="使用内存管理的地方"><a href="#使用内存管理的地方" class="headerlink" title="使用内存管理的地方"></a>使用内存管理的地方</h2><ol>
<li>多种hashTable<ol>
<li>joinhashTable</li>
<li>baseAggregateHashTable</li>
<li>partitionableHashTable</li>
<li>RadixPartitionedHashTable</li>
</ol>
</li>
<li>排序算法<ol>
<li>MergeSorter</li>
<li>RadixSort</li>
</ol>
</li>
<li>checkpoint<ol>
<li>CheckPointManager<ol>
<li>检查点</li>
</ol>
</li>
</ol>
</li>
<li>MetaBlockReader<ol>
<li>元数据reader</li>
</ol>
</li>
<li>WriteOverflowStringsToDisk<ol>
<li>string类型溢出块</li>
</ol>
</li>
<li>ColumnSegment<ol>
<li>数据列段</li>
</ol>
</li>
</ol>
<h2 id="内存管理BufferManager的接口"><a href="#内存管理BufferManager的接口" class="headerlink" title="内存管理BufferManager的接口"></a>内存管理BufferManager的接口</h2><ol>
<li>RegisterBlock，注册一个block（一般是临时block才会调用这个）</li>
<li>RegisterMemory，注册一个block（临时block），并在内存中分配一块内存关联到这个block</li>
<li>ConvertToPersistent, 把一个block持久化到磁盘中，会用指定的block_id来进行存储数据。</li>
<li>Allocate，（临时block分配）分配指定大小内存buffer，并pin在内存中，这里分配的内存不能小于BlockSize，可以大于一个BlockSize。<ol>
<li>此时Block都是咋管理的？Block都不固定大小了，怎么映射到文件中呢？</li>
<li>超过一个block大小的内存都是临时内存，不用管它跟磁盘的映射？</li>
</ol>
</li>
<li>ReAllocate，扩容，在原有的buffer之上继续扩容，因此每个buffer的大小其实不固定，只是保证是sector的倍数，那也有可能会大于一个BlockSize？看起来也是针对临时内存的分配。</li>
<li>Pin, 把磁盘中内容读取到内存中<ol>
<li>临时内存是在临时文件读取的，每个临时内存都有一个临时文件，读取时直接读取该文件的内容，读完后会删除该文件（这是为啥？之后如果要持久化到内存，会重新申请block_id，这个block_id已经没用了）。（该文件第1~4个字节是内容的长度）</li>
<li>正常内存是在数据文件里读取的，按block_id来计算位置</li>
</ol>
</li>
<li>UnPin，不再对内存中的数据进行使用，可以释放该内存给别人用<ol>
<li>该block引用计数减一</li>
<li>如果该block引用计数为0，加入到弹出队列里</li>
</ol>
</li>
<li>EvictBlock，清理内存<ol>
<li>如果当前使用的内存+需要额外内存大于bufferManager的内存限制<ol>
<li>如果弹出队列为空，表示没有可以释放的内存，那就返回失败了，此时不能再增加内存分配</li>
<li>弹出一个buffer，进行释放到文件中，然后释放内存，指导不再大于bufferManager的内存限制</li>
</ol>
</li>
</ol>
</li>
<li>PurgeQueue，清理弹出队列里被清理的BlockHandle引用</li>
</ol>
<blockquote>
<p>临时Block和正常Block区别：</p>
<ol>
<li>临时Block没有大小限制，不固定，而且是每个Block都放在自己一个单独的临时文件中</li>
<li>正常Block大小固定，是统一放在一个文件中进行管理的。</li>
</ol>
</blockquote>
<h2 id="DuckDB文件块组织方式"><a href="#DuckDB文件块组织方式" class="headerlink" title="DuckDB文件块组织方式"></a>DuckDB文件块组织方式</h2><p>SingleFileBlockManager是把一个文件拆成多个block来进行管理。</p>
<ol>
<li>有三个头部数据块，第一个是MainHeader，主要记录版本和magicnumber，第二和第三个是DataBaseHeader（主要是记录数据相关信息，还有文件里的元数据block链表头，以及数据block链表），两个是为了做checkpoint</li>
<li>MetaBlock，记录的是元数据，例如定义表结构等，还存放了其对应的表数据所在block id</li>
<li>FreeList是记录的空闲列表<ol>
<li>free list就是完全没有被使用的block</li>
<li>modifiedBlock就是被标记删除的block<ol>
<li>一般是自上次checkpoint以来，被删除的block，在本次checkpoint时，会将其加入到free list中，没有做checkpoint前，不会将其二次分配</li>
<li>在每次checkpoint时，还被用来记录哪些block记录的是freeBlockList的元数据</li>
</ol>
</li>
<li>multiUseBlock一般是被多个线程同时使用的block，并且也要被删除，只有最后一个使用者才能真正标记删除它</li>
</ol>
</li>
</ol>
<img src="/2021/11/01/duckDB%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/buffer-16357560755913.png" class="" title="buffer">

<p>如上图所示，文件列表结构如图中所示，meta_block指向的是元数据所在的block_id的列表。</p>
<p>而元数据中有一部分是block_id会指向有正常数据的block列表。</p>
<p>而free_block_id指向的是空闲列表。</p>
<p>内存中数据怎么跟磁盘中block绑定起来的？</p>
<ol>
<li>每次申请一个block，并映射到内存中，如果没写完就插入部分未写完块队列，如果写完就直接刷写到磁盘中，并在内存中记录着block id。</li>
</ol>
<h2 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h2><p>CheckPointManager</p>
<ol>
<li>元数据落盘，包括表结构，以及表的数据所在的block id等信息（实际数据其实已经落盘）。</li>
<li>部分未写完的block落盘（block空闲大于20%），这些数据是在内存中，等待后续进一步写入，这些block会被元数据记录。</li>
</ol>
<h2 id="parquet文件又是怎么支持的呢？"><a href="#parquet文件又是怎么支持的呢？" class="headerlink" title="parquet文件又是怎么支持的呢？"></a>parquet文件又是怎么支持的呢？</h2><ol>
<li>没有走bufferManager这一套，走的是vector，但是vector的内存没有跟bufferManager一样管理起来</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/24/hive-%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason Chao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我住8楼">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/24/hive-%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">hive 测试环境搭建</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-09-24 09:21:21 / 修改时间：09:50:53" itemprop="dateCreated datePublished" datetime="2021-09-24T09:21:21+08:00">2021-09-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><ol>
<li>参考<a target="_blank" rel="noopener" href="https://bbs.huaweicloud.com/blogs/207331">https://bbs.huaweicloud.com/blogs/207331</a></li>
</ol>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><h1 id="hive-beeline-连接报错User-xxx-is-not-allowed-to-impersonate"><a href="#hive-beeline-连接报错User-xxx-is-not-allowed-to-impersonate" class="headerlink" title="hive beeline 连接报错User:xxx is not allowed to impersonate"></a><a target="_blank" rel="noopener" href="https://my.oschina.net/ouminzy/blog/4456727">hive beeline 连接报错User:xxx is not allowed to impersonate</a></h1><h1 id="hive配置遇到的问题（-Relative-path-in-absolute-URI-system-java-io-tmpdir-7D-7Bsystem-user-name-7D"><a href="#hive配置遇到的问题（-Relative-path-in-absolute-URI-system-java-io-tmpdir-7D-7Bsystem-user-name-7D" class="headerlink" title="hive配置遇到的问题（ Relative path in absolute URI: ${system:java.io.tmpdir%7D/$%7Bsystem:user.name%7D"></a><a target="_blank" rel="noopener" href="https://blog.csdn.net/zwx19921215/article/details/42776589">hive配置遇到的问题（ Relative path in absolute URI: ${system:java.io.tmpdir%7D/$%7Bsystem:user.name%7D</a></h1>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/12/%E7%BC%96%E8%AF%91zookeeper-c%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason Chao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我住8楼">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/12/%E7%BC%96%E8%AF%91zookeeper-c%E5%BA%93/" class="post-title-link" itemprop="url">编译zookeeper c库</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-08-12 10:33:49 / 修改时间：15:54:20" itemprop="dateCreated datePublished" datetime="2021-08-12T10:33:49+08:00">2021-08-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="编译步骤"><a href="#编译步骤" class="headerlink" title="编译步骤"></a>编译步骤</h1><p>编译目标：zookeeper 3.4.14版本的c库</p>
<p>编译环境：ubuntu 20.04</p>
<p>依赖：cppunit库1.10.2版本，ant编译工具</p>
<h2 id="编译安装cppunit-1-10-2"><a href="#编译安装cppunit-1-10-2" class="headerlink" title="编译安装cppunit 1.10.2"></a>编译安装cppunit 1.10.2</h2><ol>
<li>下载1.10.2版本源码 <a target="_blank" rel="noopener" href="https://osdn.net/projects/sfnet_cppunit/downloads/cppunit/1.10.2/cppunit-1.10.2.tar.gz/">Downloading File /cppunit/1.10.2/cppunit-1.10.2.tar.gz - CppUnit - C++ port of JUnit - OSDN</a></li>
<li>解压源码 tar zxvf cppunit-1.10.2.tar.gz</li>
<li>进入解压后的目录cppunit-1.10.2，执行命令./configure LDFLAGS=’-ldl’  ，不加这个会导致报错 <code>undefined reference to </code>dlsym’` </li>
<li>开始编译make</li>
<li>安装make install</li>
</ol>
<h2 id="编译安装zookeeper-c的动态库"><a href="#编译安装zookeeper-c的动态库" class="headerlink" title="编译安装zookeeper c的动态库"></a>编译安装zookeeper c的动态库</h2><ol>
<li>下载zookeeper 3.4.14源码 wget <a target="_blank" rel="noopener" href="https://github.com/apache/zookeeper/archive/refs/tags/release-3.4.14.tar.gz">https://github.com/apache/zookeeper/archive/refs/tags/release-3.4.14.tar.gz</a></li>
<li>解压缩源码 tar zxvf  zookeeper-release-3.4.14.tar.gz</li>
<li>进入zookeeper解压缩的目录执行命令<ol>
<li><code>ant clean jar</code></li>
<li><code>ant complie_jute</code></li>
</ol>
</li>
<li>进入zookeeper-client/zookeeper-client-c目录执行命令<ol>
<li><code>ACLOCAL=&quot;aclocal -I /usr/local/share/aclocal&quot; autoreconf -if</code></li>
<li><code>mkdir out</code></li>
<li><code>CFLAGS=-Wno-error=format-overflow ./configure --enable-static=yes --enable-shared=yes --prefix=pwd/out --with-pic=yes</code><ol>
<li>不加CFLAGS，会导致gcc9 报错<code>error: &#39;%d&#39; directive writing between 1 and 5 bytes into a region of size</code> </li>
</ol>
</li>
<li><code>make</code></li>
<li><code>make install</code></li>
</ol>
</li>
<li>可以在当前路径下out目录里看到zk开发需要的相关库</li>
</ol>
<h1 id="编写c-代码实现分布式锁"><a href="#编写c-代码实现分布式锁" class="headerlink" title="编写c++代码实现分布式锁"></a>编写c++代码实现分布式锁</h1><p>参考<a target="_blank" rel="noopener" href="https://github.com/hthao/ZKLockGuard">hthao/ZKLockGuard: An implementation of distributed lock with zookeeper. (github.com)</a></p>
<ol>
<li>进入out目录下</li>
<li>然后创建三个文件，一个是main.cpp，另外两个直接下载上面github库的代码，命名为zk_hello.h zk_hello.cpp</li>
<li>编写cmake文件来编译代码</li>
<li>然后去zk上创建/dlock/test目录<ol>
<li>使用zkcli来创建</li>
</ol>
</li>
<li>执行生成的二进制./main，可以看到创建锁成功</li>
</ol>
<p>main.cpp文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;vector&gt;</span><br><span class="line">#include &quot;zk_hello.h&quot;</span><br><span class="line"></span><br><span class="line">void defaultWatcher(zhandle_t* zh, int type, int state, const char* path, void* watcherCtx) &#123;</span><br><span class="line">        &#x2F;&#x2F;do nothing.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">zhandle_t* zh &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">bool init(const char* zkHost)</span><br><span class="line">&#123;</span><br><span class="line">        int count &#x3D; 0;</span><br><span class="line">        do &#123;</span><br><span class="line">                count++;</span><br><span class="line">                zh &#x3D; zookeeper_init(zkHost, &amp;defaultWatcher, 10000, 0, NULL, 0);</span><br><span class="line">        &#125; while (!zh &amp;&amp; count &lt; 3);</span><br><span class="line"></span><br><span class="line">        if (!zh) &#123;</span><br><span class="line">                printf(&quot;zookeeper_init failed!!!\n&quot;);</span><br><span class="line">                return false;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">                printf(&quot;zookeeper_init successfully.\n&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">        if (!init(&quot;172.16.48.4:2181,172.16.48.5:2181,172.16.48.7:2181&quot;)) &#123;</span><br><span class="line">                return -1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">                &#x2F;&#x2F;attemp to lock</span><br><span class="line">                sandsea::ZKLockGuard lock(zh, &quot;&#x2F;dlock&#x2F;test&quot;, &quot;myUniqueString&quot;);</span><br><span class="line">                &#x2F;&#x2F;got the lock,</span><br><span class="line">                &#x2F;&#x2F;do something</span><br><span class="line">                sleep(10);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;lock is released.</span><br><span class="line"></span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>CMakeLists.txt文件如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">project(zk_hello)</span><br><span class="line"></span><br><span class="line">set(CMAKE_CXX_STANDARD 11)</span><br><span class="line"></span><br><span class="line">include_directories($&#123;CMAKE_SOURCE_DIR&#125;&#x2F;include)</span><br><span class="line">link_directories($&#123;CMAKE_SOURCE_DIR&#125;&#x2F;lib)</span><br><span class="line"></span><br><span class="line">add_definitions(&quot;-Wall -g&quot;)</span><br><span class="line">add_executable(main main.cpp zk_hello.cpp)</span><br><span class="line"></span><br><span class="line">target_link_libraries(main pthread zookeeper_mt)</span><br></pre></td></tr></table></figure>


<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zpxly/article/details/25052357">(11条消息) 编译cppunit出现dlopen未找到_cfmlovers的专栏-CSDN博客</a></li>
<li>[Zookeeper安装后，编译C client时报错”syntax error near unexpected token `1.10.2” - hbg-rohens - 博客园 (cnblogs.com)](<a target="_blank" rel="noopener" href="https://www.cnblogs.com/rohens-hbg/p/12618154.html">https://www.cnblogs.com/rohens-hbg/p/12618154.html</a>)</li>
<li><a target="_blank" rel="noopener" href="https://github.com/XiaoMi/rdsn/pull/667">fix: compile error of zookeeper 3.4.10 on gcc9 by neverchanje · Pull Request #667 · XiaoMi/rdsn (github.com)</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/04/h2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9001/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason Chao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我住8楼">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/04/h2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9001/" class="post-title-link" itemprop="url">h2源码分析01</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-04 23:02:47" itemprop="dateCreated datePublished" datetime="2021-08-04T23:02:47+08:00">2021-08-04</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-06 23:08:28" itemprop="dateModified" datetime="2021-09-06T23:08:28+08:00">2021-09-06</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="h2代码架构"><a href="#h2代码架构" class="headerlink" title="h2代码架构"></a>h2代码架构</h1><p>从上到下分为8层：</p>
<ul>
<li>JDBC driver<ul>
<li>jdbc层，源码在org.h2.jdbc, org.h2.jdbcx两个包下</li>
</ul>
</li>
<li>Connection/session management<ul>
<li>链接和会话管理</li>
<li>主要相关类是org.h2.engine.database/session/sessionlocal/sessionremote</li>
</ul>
</li>
<li>SQL Parser.<ul>
<li>词法和语法解析器</li>
<li>使用递归下降算法来进行解析</li>
</ul>
</li>
<li>Command execution and planning.<ul>
<li>命令执行和计划</li>
<li>相关实现在org.h2.command/expression包下，h2没有生成中间层（一般是逻辑计划层），而是直接生成物理执行计划</li>
</ul>
</li>
<li>Table/Index/Constraints.<ul>
<li>表、索引、约束</li>
<li>相关实现在org.h2.index/table/constraint包下</li>
</ul>
</li>
<li>Undo log, redo log, and transactions layer.<ul>
<li>撤销日志，重做日志，事务管理</li>
<li>事务日志是重做日志，所有session共享；撤销日志是每个session一个，主要是为了撤销操作和回滚事务。理论上，事务日志也是可以使用的，不过为了简便，h2当前只使用它自己的“操作列表”（通常在内存中）。对于MVStore，不再需要它（只需要事务日志）</li>
</ul>
</li>
<li>B-tree engine and page-based storage allocation.<ul>
<li>B树和存储管理分配，主要是基于页的分配和B树索引</li>
<li>代码在包org.h2.store里</li>
</ul>
</li>
<li>Filesystem abstraction.<ul>
<li>文件系统抽象，实现可随机访问的文件抽象，方便屏蔽底层内存，磁盘， 或者压缩后的文件的读写</li>
<li>代码在org.h2.store.fs里</li>
</ul>
</li>
</ul>
<h1 id="Server启动服务流程"><a href="#Server启动服务流程" class="headerlink" title="Server启动服务流程"></a>Server启动服务流程</h1><p>以下是h2启动后处理命令，并返回结果会涉及到的主要的类：</p>
<ol>
<li>启动服务是TcpServer</li>
<li>正在处理逻辑是TcpServerThread</li>
<li>TcpServerThread通过SessionLocal来管理跟远程客户端的会话信息</li>
<li>TcpServerThread通过Transfer来跟远程客户端进行消息通信</li>
<li>SessionLocal通过parser来解析语句成Prepared</li>
<li>Prepared准备好要执行的参数和资源，然后生成Command</li>
<li>Command执行后得到Result</li>
<li>TcpServerThread把Result通过Transfer返回给远程客户端</li>
</ol>
<img src="/2021/08/04/h2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9001/TcpServer.png" class="" title="TcpServer">



<p>Server类和service类</p>
<p>Server类是用来启动对应的服务的，默认启动三个：</p>
<ol>
<li>TcpServer：主要用来接受远程链接的，支持h2自己的协议</li>
<li>PgServer：也是用来接收远程链接的，支持pg的协议</li>
<li>WebServer：主要是webconsole，在网页可以直接请求访问一个本地或者远程的h2</li>
</ol>
<img src="/2021/08/04/h2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9001/Service-16283493788731.png" class="" title="Service">



<h2 id="transfer类"><a href="#transfer类" class="headerlink" title="transfer类"></a>transfer类</h2><p>主要是用来封装下数据socket，提供一些网络流对于不同基础数据类型的读写函数</p>
<h2 id="TcpServer类"><a href="#TcpServer类" class="headerlink" title="TcpServer类"></a>TcpServer类</h2><p>初始化启动时，调用start方法：</p>
<ol>
<li>挑选一个合适的端口进行监听</li>
<li>创建管理session的内存数据库</li>
<li>创建关闭数据库的函数</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">       stop = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           serverSocket = NetUtils.createServerSocket(port, ssl);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (DbException e) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!portIsSet) &#123;</span><br><span class="line">               serverSocket = NetUtils.createServerSocket(<span class="number">0</span>, ssl);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">throw</span> e;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       port = serverSocket.getLocalPort(); <span class="comment">// 随机获取一个端口</span></span><br><span class="line">       initManagementDb();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initManagementDb</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (managementPassword.isEmpty()) &#123;</span><br><span class="line">           managementPassword = StringUtils.convertBytesToHex(MathUtils.secureRandomBytes(<span class="number">32</span>));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// avoid using the driver manager</span></span><br><span class="line">       JdbcConnection conn = <span class="keyword">new</span> JdbcConnection(<span class="string">&quot;jdbc:h2:&quot;</span> + getManagementDbName(port), <span class="keyword">null</span>, <span class="string">&quot;&quot;</span>, managementPassword);</span><br><span class="line">       managementDb = conn;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> (Statement stat = conn.createStatement()) &#123;</span><br><span class="line">           stat.execute(<span class="string">&quot;CREATE ALIAS IF NOT EXISTS STOP_SERVER FOR &#x27;&quot;</span> + TcpServer.class.getName() + <span class="string">&quot;.stopServer&#x27;&quot;</span>); <span class="comment">// 创建自定义函数，用来支持通过发命令停止h2数据库</span></span><br><span class="line">           stat.execute(<span class="string">&quot;CREATE TABLE IF NOT EXISTS SESSIONS&quot;</span> +</span><br><span class="line">                   <span class="string">&quot;(ID INT PRIMARY KEY, URL VARCHAR, `USER` VARCHAR, &quot;</span> +</span><br><span class="line">                   <span class="string">&quot;CONNECTED TIMESTAMP(9) WITH TIME ZONE)&quot;</span>);</span><br><span class="line">           managementDbAdd = conn.prepareStatement(</span><br><span class="line">                   <span class="string">&quot;INSERT INTO SESSIONS VALUES(?, ?, ?, CURRENT_TIMESTAMP(9))&quot;</span>);</span><br><span class="line">           managementDbRemove = conn.prepareStatement(</span><br><span class="line">                   <span class="string">&quot;DELETE FROM SESSIONS WHERE ID=?&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       SERVERS.put(port, <span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>


<p>另外一个就是监听方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        listenerThread = Thread.currentThread();</span><br><span class="line">        String threadName = listenerThread.getName();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!stop) &#123;</span><br><span class="line">                Socket s = serverSocket.accept();</span><br><span class="line">                Utils10.setTcpQuickack(s, <span class="keyword">true</span>);  <span class="comment">// 用来降低小包的延迟的，防止nagle算法优化导致网络小包数据传输延迟比较高</span></span><br><span class="line">                <span class="keyword">int</span> id = nextThreadId++;</span><br><span class="line">                TcpServerThread c = <span class="keyword">new</span> TcpServerThread(s, <span class="keyword">this</span>, id);</span><br><span class="line">                running.add(c);</span><br><span class="line">                Thread thread = <span class="keyword">new</span> Thread(c, threadName + <span class="string">&quot; thread-&quot;</span> + id);</span><br><span class="line">                thread.setDaemon(isDaemon); <span class="comment">// 启动一个后台线程进行处理链接请求</span></span><br><span class="line">                c.setThread(thread);</span><br><span class="line">                thread.start();</span><br><span class="line">            &#125;</span><br><span class="line">            serverSocket = NetUtils.closeSilently(serverSocket);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!stop) &#123;</span><br><span class="line">                DbException.traceThrowable(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stopManagementDb();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="TcpServerThread类"><a href="#TcpServerThread类" class="headerlink" title="TcpServerThread类"></a>TcpServerThread类</h2><p>两个重要方法：</p>
<ol>
<li>run，启动函数，主要是根据跟client的链接进行一些检查和设置</li>
<li>process，循环处理client的请求<ol>
<li>处理来自客户端的一些命令，总有19条，其中process只处理其中的17条，run函数里处理剩下的两个。从大到小共分成三类：<ol>
<li>Session级</li>
<li>Command级</li>
<li>Result级</li>
</ol>
</li>
</ol>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_PREPARE = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_CLOSE = <span class="number">1</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMMAND_EXECUTE_QUERY = <span class="number">2</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMMAND_EXECUTE_UPDATE = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMMAND_CLOSE = <span class="number">4</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESULT_FETCH_ROWS = <span class="number">5</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESULT_RESET = <span class="number">6</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESULT_CLOSE = <span class="number">7</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMMAND_COMMIT = <span class="number">8</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CHANGE_ID = <span class="number">9</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMMAND_GET_META_DATA = <span class="number">10</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_PREPARE_READ_PARAMS = <span class="number">11</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_SET_ID = <span class="number">12</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_CANCEL_STATEMENT = <span class="number">13</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_CHECK_KEY = <span class="number">14</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_SET_AUTOCOMMIT = <span class="number">15</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_HAS_PENDING_TRANSACTION = <span class="number">16</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOB_READ = <span class="number">17</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_PREPARE_READ_PARAMS2 = <span class="number">18</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> GET_JDBC_META = <span class="number">19</span>;</span><br></pre></td></tr></table></figure>
<h1 id="解析器"><a href="#解析器" class="headerlink" title="解析器"></a>解析器</h1><h2 id="词法解析器"><a href="#词法解析器" class="headerlink" title="词法解析器"></a>词法解析器</h2><p>字符流被分为以下几类：</p>
<ol>
<li>CHAR_END<ol>
<li>字符流结束</li>
</ol>
</li>
<li>CHAR_VALUE<ol>
<li>标识符</li>
</ol>
</li>
<li>CHAR_QUOTED<ol>
<li>双引号，一般用来把别名包起来</li>
</ol>
</li>
<li>CHAR_NAME<ol>
<li>标识符</li>
</ol>
</li>
<li>CHAR_SPECIAL_1<ol>
<li>只是一个符号组成一个运算符，例如&lt;</li>
</ol>
</li>
<li>CHAR_SPECIAL_2<ol>
<li>两个符号组成一个运算符，例如||，&amp;&amp;</li>
</ol>
</li>
<li>CHAR_STRING<ol>
<li>单引号括起来的字符串    </li>
</ol>
</li>
<li>CHAR_DOT<ol>
<li>点符号</li>
</ol>
</li>
<li>CHAR_DOLLAR_QUOTED_STRING<ol>
<li>两个$$符号包起来的字符串</li>
</ol>
</li>
</ol>
<p>词法解析器比较简单，将token流按需要支持的token类型进行分类，分成上述的9大类。</p>
<p>对整个sql字符串进行一个字符一个字符的拆解，然后按类型进行标识。</p>
<h2 id="语法解析器"><a href="#语法解析器" class="headerlink" title="语法解析器"></a>语法解析器</h2><p>语法解析器主要是按H2需要支持的语法，对token流进行解析。</p>
<p>大概思路是：</p>
<p>读取第一个token，找到其所属的表达式类型，然后再按该表达式类型进行后续的token解析，如果解析不通就直接报错</p>
<h1 id="trace机制"><a href="#trace机制" class="headerlink" title="trace机制"></a>trace机制</h1><h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><h2 id="DDL"><a href="#DDL" class="headerlink" title="DDL"></a>DDL</h2><h3 id="Create-Schema"><a href="#Create-Schema" class="headerlink" title="Create Schema"></a>Create Schema</h3><blockquote>
<p>create schema (if not exist) ? name (authorization ownerUserName)? (With tableEngineParamName)?</p>
</blockquote>
<h3 id="Create-Table"><a href="#Create-Table" class="headerlink" title="Create Table"></a>Create Table</h3><blockquote>
</blockquote>
<h3 id="Create-View"><a href="#Create-View" class="headerlink" title="Create View"></a>Create View</h3><h3 id="Create-Index"><a href="#Create-Index" class="headerlink" title="Create Index"></a>Create Index</h3><blockquote>
<p>create (unique  (hash | spatial) ?  index  ((if not exists) ? newIndexName) ?  | primary key (hash) ? ) ? on tableName  (indexColumn) </p>
</blockquote>
<h3 id="Create-Trigger"><a href="#Create-Trigger" class="headerlink" title="Create Trigger"></a>Create Trigger</h3><h3 id="Create-Role"><a href="#Create-Role" class="headerlink" title="Create Role"></a>Create Role</h3><blockquote>
<p>create role (if not exist) ? name</p>
</blockquote>
<h3 id="Create-User"><a href="#Create-User" class="headerlink" title="Create User"></a>Create User</h3><h3 id="Create-Linked-Table"><a href="#Create-Linked-Table" class="headerlink" title="Create Linked Table"></a>Create Linked Table</h3><h3 id="Create-Sequence"><a href="#Create-Sequence" class="headerlink" title="Create Sequence"></a>Create Sequence</h3><h3 id="Create-Domain"><a href="#Create-Domain" class="headerlink" title="Create Domain"></a>Create Domain</h3><blockquote>
<p>create domain (if not exists) ? newDomainName as DataType (default expression) ?  ((not)? null) ? (selectivity selectivityInt) ? (check condition) ?</p>
</blockquote>
<h3 id="Create-Constant"><a href="#Create-Constant" class="headerlink" title="Create Constant"></a>Create Constant</h3><blockquote>
<p>create constant (if not exists) ? newConstantName Value expression</p>
</blockquote>
<h3 id="Create-Alias"><a href="#Create-Alias" class="headerlink" title="Create Alias"></a>Create Alias</h3><blockquote>
<p>create alias (if not exists)? newfunctionAliasName  (deterministic) ?   for classAndMethodName / As SourceCodeString</p>
</blockquote>
<h3 id="Create-Aggregate"><a href="#Create-Aggregate" class="headerlink" title="Create Aggregate"></a>Create Aggregate</h3><blockquote>
<p>create aggregate (if not exists) ? newAggregateName for className</p>
</blockquote>
<h2 id="DML"><a href="#DML" class="headerlink" title="DML"></a>DML</h2><h2 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h2><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://www.h2database.com/html/architecture.html">Architecture (h2database.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/codefollower/H2-Research/blob/master/h2/src/main/org/h2/server/TcpServer.java">H2-Research/TcpServer.java at master · codefollower/H2-Research (github.com)</a></li>
<li><a target="_blank" rel="noopener" href="http://www.h2database.com/html/commands.html#create_schema">http://www.h2database.com/html/commands.html#create_schema</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/29/SQLite%E9%A1%B5%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason Chao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我住8楼">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/29/SQLite%E9%A1%B5%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">SQLite页管理模块</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-07-29 23:15:31 / 修改时间：23:17:20" itemprop="dateCreated datePublished" datetime="2021-07-29T23:15:31+08:00">2021-07-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Pager模块概览"><a href="#Pager模块概览" class="headerlink" title="Pager模块概览"></a>Pager模块概览</h1><p>承担四个功能：</p>
<ol>
<li>锁管理</li>
<li>事务管理</li>
<li>日志管理</li>
<li>数据管理</li>
</ol>
<p><img src="C:/Users/94121/AppData/Local/Temp/企业微信截图_1627571797387.png" alt="img"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/11/SQLite%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason Chao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我住8楼">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/11/SQLite%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">SQLite事务管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-11 20:46:49" itemprop="dateCreated datePublished" datetime="2021-07-11T20:46:49+08:00">2021-07-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-29 23:14:10" itemprop="dateModified" datetime="2021-07-29T23:14:10+08:00">2021-07-29</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="事务类型"><a href="#事务类型" class="headerlink" title="事务类型"></a>事务类型</h1><h2 id="系统事务"><a href="#系统事务" class="headerlink" title="系统事务"></a>系统事务</h2><h3 id="系统事务-1"><a href="#系统事务-1" class="headerlink" title="系统事务"></a>系统事务</h3><p>每条语句都会被包装成一个事务的形式进行执行。一个应用可以在一个数据库链接中并发执行多个查询事务，但是只能执行一个写入事务。</p>
<h3 id="用户事务"><a href="#用户事务" class="headerlink" title="用户事务"></a>用户事务</h3><p>默认系统事务时自动提交模式，即针对每条语句都会有事务包装起来执行。对于写入比较频繁的应用来说性能非常不友好。因为一次写事务提交都涉及到重新打开、写入和关闭日志文件的操作。并且，这还有并发控制的开销，因为应用需要为每个语句执行重新获取和释放锁。</p>
<p>通过将多条语句组合成一个用户事务，可以降低这些性能开销。</p>
<h3 id="子事务"><a href="#子事务" class="headerlink" title="子事务"></a>子事务</h3><p>在一个用户事务中，连续的非查询操作可以作为一个子事务执行。而查询操作则是单独的子事务操作。如果一个用户事务里有几个联系非查询操作，它们会作为一个子事务来执行。如果其中某个执行失败了，数据库会恢复到这个操作之前的状态，然后接着执行下一个操作。</p>
<p>当前有五种处理违反约束的更新后的回滚策略：</p>
<ol>
<li>回滚，中止当前子事务</li>
<li>中止当前语句，但是当前子事务的其他语句还是继续执行，这个也是默认策略</li>
<li>失败，接受当前语句执行失败后的改动，并停止当前语句更进一步的改动。整个子事务继续执行。</li>
<li>忽略，当前语句更新的有问题的行的更新被忽略，整个子事务继续执行。</li>
<li>替代，违反约束的行直接被移除，子事务继续执行。</li>
</ol>
<h2 id="锁管理"><a href="#锁管理" class="headerlink" title="锁管理"></a>锁管理</h2><p>目前只有数据库级别的锁。</p>
<h3 id="锁类型"><a href="#锁类型" class="headerlink" title="锁类型"></a>锁类型</h3><ol>
<li>NOLOCK<ol>
<li>事务初始状态就是无锁的，不能读写数据库</li>
</ol>
</li>
<li>SHARED<ol>
<li>允许读。任意数量的事务都可以获得共享锁。只有当所有的共享锁被释放了，才能执行写操作。</li>
</ol>
</li>
<li>EXCLUSIVE<ol>
<li>写锁。一个数据库只有一个写锁。如果存在写锁，其他的锁都不能存在。</li>
</ol>
</li>
<li>RESERVED<ol>
<li>预留锁。这个事务过会儿要执行写，不过当前只是读。其他的事务还是可以继续加shared锁。</li>
</ol>
</li>
<li>PENGDING<ol>
<li>阻塞锁。这个事务马上要执行写，此时就是在等所有的shared锁被释放，然后转成exclusive锁。其他的事务不能再加锁了。</li>
</ol>
</li>
</ol>
<p><img src="C:/Users/94121/AppData/Local/Temp/企业微信截图_1627450277474.png" alt="img"></p>
<h3 id="锁获取顺序"><a href="#锁获取顺序" class="headerlink" title="锁获取顺序"></a>锁获取顺序</h3><p><img src="C:/Users/94121/AppData/Local/Temp/企业微信截图_16274509232827.png" alt="img"></p>
<p>正常获取锁的顺序是上图黑色粗线的顺序。</p>
<p>从Shared到Pending，只有一种情况会发生：当一个事务在读时，需要进行日志回滚。</p>
<p>这些锁对用户不会暴露，全都是lockmanager自己进行锁获取和释放。</p>
<h3 id="死锁和饥饿"><a href="#死锁和饥饿" class="headerlink" title="死锁和饥饿"></a>死锁和饥饿</h3><p>当两个事务同时获得shared锁，然后都要去获取Reserved锁时，其中一个成功，但是他要等待别的事务释放shared 锁才能变成exclusive锁。此时就产生死锁。解决办法就是在事务内多次尝试获得锁，如果超过指定次数锁还未获得，就释放掉自己的锁。</p>
<p>但是这样还会有一个饥饿的问题，就是多个事务一直并发获得锁，然后都尝试多次失败，再回滚事务，导致一直没法进行下去。也可以称为活锁。</p>
<h3 id="锁实现"><a href="#锁实现" class="headerlink" title="锁实现"></a>锁实现</h3><p>如下图所示，sqlite使用不同区域来加不同的锁的方式实现四种锁。</p>
<p>linux只支持两种文件锁：读锁和写锁。写锁是排他的。但是锁可以锁定文件的某段区域，因此一个文件可能会同时存在多把锁，只要它们区域不一样。</p>
<p>sqlite锁的实现方式如下：</p>
<ol>
<li>shared锁，通过在指定区域加读锁来实现</li>
<li>exclusive锁，通过给指定区域的所有字节加上写锁。</li>
<li>reserved锁，通过在某个指定的字节里加上写锁来实现的。</li>
<li>pending锁，也在另一个指定的字节里加上写锁来实现的。</li>
</ol>
<p>如下图所示：</p>
<p>锁页的起始位置定义在PENDING_BYTE里。第一个字节是pending锁字节，第二个字节是reserve锁字节。第三个开始接下来510个字节是shared锁字节。</p>
<p><img src="C:/Users/94121/AppData/Local/Temp/企业微信截图_1627484504367.png" alt="img"></p>
<h4 id="sqlite锁映射成文件锁"><a href="#sqlite锁映射成文件锁" class="headerlink" title="sqlite锁映射成文件锁"></a>sqlite锁映射成文件锁</h4><ol>
<li>一个进程如果要获得shared锁，先获取pending byte的读锁（这个主要是为了确保没有别的进程获取到pending锁了），如果获取成功，说明从shared first开始的都是读锁。这个pending的读锁最终会被释放掉。</li>
<li>一个进程只有在获得shared锁之后才能获得reserved锁，在reserved byte加上写锁即可。但是它本身的shared锁不会被释放，这个为了防止别的进程也获得exclude锁。（这个是为何？不加shared锁，就有可能别的进程也能获得exclusive锁？）</li>
<li>一个进程只有在获得shared锁之后才能获得pending锁，在pending byte加上写锁即可。但是它本身的shared锁不会被释放，这个为了防止别的进程也获得reserved锁。（这个是为何？不加shared锁，就有可能别的进程也能获得exclusive锁？因为获取exclusive锁需要其他进程的shared锁都释放掉，假设有没有释放的就不能加上exclusive锁）</li>
<li>一个进程只有在获得pending锁之后才能获得exclusive锁。为了获得exclusive锁，需要在所有的shared byte上加上写锁即可。</li>
</ol>
<p><img src="C:/Users/94121/AppData/Local/Temp/企业微信截图_16274868398561.png" alt="img"></p>
<h4 id="工程问题"><a href="#工程问题" class="headerlink" title="工程问题"></a>工程问题</h4><ol>
<li>锁映射问题，一个进程只能获得一个文件的一把锁，如果多线程，那就sqlite自己模拟出多个锁对象unixFile，但是共享一个unixInodeInfo对象，这个对象才是这个进程对文件的linux锁。</li>
</ol>
<p><img src="C:/Users/94121/AppData/Local/Temp/企业微信截图_16274878971206.png" alt="img"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/06/sqlite%E6%96%87%E4%BB%B6%E6%8E%A2%E7%B4%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason Chao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我住8楼">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/06/sqlite%E6%96%87%E4%BB%B6%E6%8E%A2%E7%B4%A2/" class="post-title-link" itemprop="url">sqlite文件探索</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-06 22:18:12" itemprop="dateCreated datePublished" datetime="2021-07-06T22:18:12+08:00">2021-07-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-11 20:45:56" itemprop="dateModified" datetime="2021-07-11T20:45:56+08:00">2021-07-11</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="存储组织"><a href="#存储组织" class="headerlink" title="存储组织"></a>存储组织</h1><h2 id="数据命名规则"><a href="#数据命名规则" class="headerlink" title="数据命名规则"></a>数据命名规则</h2><p>应用程序通过向sqlite3_open传入数据库文件名来打开数据库。文件名可以是相对路径也可以是绝对路径。SQLite支持常见的文件系统支持的文件名，但是有两条例外：</p>
<ul>
<li><p> 如果文件名是c语言NULL指针（例如：0）或者空字符串，或者只包含空字符的字符串，SQLite打开一个新的临时文件</p>
</li>
<li><p>如果文件名是”:memory:”，SQLite创建一个只在内存中存在的数据库(in-memory database)</p>
</li>
</ul>
<p>在这两种情况下创建的数据库文件是临时的，只要数据库关闭，文件就会消失。</p>
<blockquote>
<p>临时文件的作用：回滚日志、语句日志、多数据库主机日志、临时索引、vacuum命令使用的临时数据库、物化视图以及子查询</p>
</blockquote>
<p>在SQLite内部，数据库文件的名字不是数据库名。他们是两个不同的概念。通过使用attach命令，你可以将一个同样的数据库文件以一个不同的数据库名称连接到一个数据库连接上。你可以通过这些数据库名称对数据库文件进行操作。更多有关attach的信息请查询官网。</p>
<p>如下图所示：每当应用程序使用sqlite3_open打开一个数据库连接，SQLite就为这个数据库连接维护一个独立的临时数据库，这个临时数据库被命名为temp。temp数据库存储临时实体，例如：表和索引。（应用程序可以在SQL语句中使用main或者temp，例如：select * from temp.table1将返回temp数据库的table1的所有行，而不是从main数据库返回这些信息。Temp数据库的目录名是sqlite_temp_master）临时实体只对本数据库连接是可见的（而不是指向同一个文件的，同一个线程、进程或者其他进程中的数据库连接）。SQLite将temp数据库存储在一个单独的临时文件中，而不是存储在main数据库文件中。当应用程序关闭数据库连接的时候，temp文件将被删除。</p>
<p><em>临时数据库用来干什么的呢？为什么关闭后要删除？只是为了方便用户操作一些临时信息，而不用再attach一个临时数据库</em></p>
<img src="/2021/07/06/sqlite%E6%96%87%E4%BB%B6%E6%8E%A2%E7%B4%A2/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16255823128073.png" class="" title="img">

<h2 id="数据库文件格式"><a href="#数据库文件格式" class="headerlink" title="数据库文件格式"></a>数据库文件格式</h2><p>如下图所示：数据库文件划分为多个固定大小的页</p>
<img src="/2021/07/06/sqlite%E6%96%87%E4%BB%B6%E6%8E%A2%E7%B4%A2/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16256677282275.png" class="" title="img">

<p>默认页大小是1024B，可以在编译的时候指定默认值。大小范围是512~65536，不过页的大小必须得是2的幂次方。也可以在创建表之前通过一个参数page_size来制定页大小。</p>
<h3 id="页类型"><a href="#页类型" class="headerlink" title="页类型"></a>页类型</h3><ul>
<li>free：未使用的页</li>
<li>tree<ul>
<li>leaf, B+树的叶子节点会存放数据，如果一个页存放不下，剩下部分会存到溢出页中</li>
<li>internal，B+树的内部节点存放的是下一层节点的索引，B树则是索引和数据都会存放，B树一般用来做索引，B+树则是存数据</li>
<li>overflow</li>
</ul>
</li>
<li>pointer-map：</li>
<li>lock-byte</li>
</ul>
<h3 id="Page-1"><a href="#Page-1" class="headerlink" title="Page 1"></a>Page 1</h3><p>page 1是特殊的，一般用来存放B树根节点，以及前100字节的数据库相关属性信息</p>
<img src="/2021/07/06/sqlite%E6%96%87%E4%BB%B6%E6%8E%A2%E7%B4%A2/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16256683475039.png" class="" title="img">

<p>下面是header的内容，页被分成多个cell。</p>
<p>其中22-24字节的意思：</p>
<ol>
<li>最大碎片负载（偏移量是21）指的是每页能够用于存储B/B+树内部节点的空间。255表示100%。默认值是64（25%），这个值用来限定cell的最大值，即每个节点最少有4个cell。如果cell的大小超过允许的最大值，SQLite就创建溢出页，把尽量多的byte移动到溢出页中，但是不能在分割的过程中导致cell的大小小于最小embedded payload(偏移量是22，默认值是32，即12.5%)。</li>
<li>叶子页最小负载（偏移量23）和最小embedded payload相似，但是是针对B+树的叶子页来说的。（默认值是32,12.5%）。叶子页的最大负载百分比永远是100%，文件头中并没有保存该值的变量。</li>
</ol>
<img src="/2021/07/06/sqlite%E6%96%87%E4%BB%B6%E6%8E%A2%E7%B4%A2/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16256691984879.png" class="" title="img">



<h3 id="Incremental-Vacuum-amp-Autovacuum"><a href="#Incremental-Vacuum-amp-Autovacuum" class="headerlink" title="Incremental Vacuum &amp; Autovacuum"></a><strong>Incremental Vacuum &amp; Autovacuum</strong></h3><p>vacuum命令可以清空自由页链表。该命令在内存中建立一个数据库的副本（这个副本是通过INSERT INTO…SELECT * FROM…命令实现的）。然后在事务系统的保护下，用内存中的副本重写原始数据库。</p>
<h3 id="free-list"><a href="#free-list" class="headerlink" title="free list"></a>free list</h3><p>自由页链表（偏移量32）存储未使用的页。自由页页数存储在偏移量36。在自由页链表中页有两种类型：主干页和叶子页。文件头指出了自由页链表中的第一个主干页。每一个主干页里含有指向许多叶子页的指针。</p>
<img src="/2021/07/06/sqlite%E6%96%87%E4%BB%B6%E6%8E%A2%E7%B4%A2/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16256704019401.png" class="" title="img">

<p>主干页的格式如下所示：</p>
<ul>
<li><p>下一个主干页的页号（4bytes）</p>
</li>
<li><p>本页中含有的叶子页指针个数（4bytes）</p>
</li>
<li><p>0或者更多4bytes叶子页页号</p>
</li>
</ul>
<p>当一个页变为非激活态，SQLite将该页添加到自由页链表中，并不会把页释放给本地文件系统。当你向数据库中添加新的数据的时候，SQLite从自由页链表中取出一页用来存储用户添加的数据。如果自由页链表是空的，SQLite向本地文件系统申请新的页，把新页附加到数据库文件上。</p>
<h2 id="日志文件格式"><a href="#日志文件格式" class="headerlink" title="日志文件格式"></a>日志文件格式</h2><p>SQLite最新的支持wal日志，后面会介绍。下面是一些旧的日志格式设计。</p>
<h3 id="回滚日志"><a href="#回滚日志" class="headerlink" title="回滚日志"></a>回滚日志</h3><p>回滚日志跟数据库文件在同一个目录下，每次写事务开始时创建，事务完成后就被删除。它的名字是数据库名字-journal。</p>
<h4 id="日志整体结构"><a href="#日志整体结构" class="headerlink" title="日志整体结构"></a>日志整体结构</h4><p>如下图所示，是回滚日志的结构。日志会被分成多个日志段，每个日志段会有一个头部。</p>
<img src="/2021/07/06/sqlite%E6%96%87%E4%BB%B6%E6%8E%A2%E7%B4%A2/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16257554339707.png" class="" title="img">

<h4 id="日志段header结构"><a href="#日志段header结构" class="headerlink" title="日志段header结构"></a>日志段header结构</h4><img src="/2021/07/06/sqlite%E6%96%87%E4%BB%B6%E6%8E%A2%E7%B4%A2/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16257553541447.png" class="" title="img">

<p>下面是各个字段的解释。</p>
<blockquote>
<p> 其中需要说明的是第16字节开始的4个字节，表示的是当前日志文件创建时数据库中含有的页个数。</p>
</blockquote>
<img src="/2021/07/06/sqlite%E6%96%87%E4%BB%B6%E6%8E%A2%E7%B4%A2/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16257556265152.png" class="" title="img">

<h4 id="日志记录结构"><a href="#日志记录结构" class="headerlink" title="日志记录结构"></a>日志记录结构</h4><img src="/2021/07/06/sqlite%E6%96%87%E4%BB%B6%E6%8E%A2%E7%B4%A2/image-20210710224302053.png" class="" title="image-20210710224302053">

<p>需要说明的是校验和的位置的安排是为了简单快速的检测到大概率出现的日志损坏问题。</p>
<ol>
<li>因为如果一条日志损坏，大概率是因为掉电导致的。而写入一般都是线性写入，因此只会出现一条日志的末尾或者中间是有问题，而不会出现两端没有问题，只有中间出问题的情况。<ol>
<li>这里意思是checksum如果放在前面，那page number和checksum可能是对的，但是后面的data page image则可能发生了变化。但是最后校验的时候不就知道有问题了么？</li>
<li><strong>可能data page image没写成功，但是checksum还是跟原来一样。但是如果把checksum放到最后，如果data page image没有写成功，checksum肯定也没写成功，那不可能出现成功的校验？</strong></li>
</ol>
</li>
<li>另外，检验和校验的东西包括page number和中间的数据，还把日志段的头部那个随机数作为key，这样能尽量防止垃圾数据被认为是有效数据的概率。因为垃圾数据一般是旧的未删除的日志文件里的，每次新的日志段都会产生新的随机数，因此加上这个，能降低检验和一致，但是数据其实不一致的问题。</li>
</ol>
<h3 id="语句声明日志"><a href="#语句声明日志" class="headerlink" title="语句声明日志"></a>语句声明日志</h3><p>用来支持语句中止功能的。当有语句执行出错时，就需要语句声明日志来把数据恢复到正常的状态。它实际上是一个临时的回滚日志。</p>
<h3 id="多数据库事务日志"><a href="#多数据库事务日志" class="headerlink" title="多数据库事务日志"></a>多数据库事务日志</h3><p>跨数据库事务时，因为每个数据库都有自己的回滚日志，因此跨数据库事务非原子的。为了做到原子，就支持一种多数据库事务日志，这种日志只包含子事务的回滚日志文件路径。跨数据库事务文件只有在要提交事务时才创建，如果事务中止，不会创建。</p>
<p>如下图所示，每个子事务日志也包含一条跨数据库事务文件的路径记录。这个记录是在事务提交的时候append进去的。</p>
<img src="/2021/07/06/sqlite%E6%96%87%E4%BB%B6%E6%8E%A2%E7%B4%A2/image-20210711145809505.png" class="" title="image-20210711145809505">

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol>
<li>SQLite的数据都存放在一个文件中，一个数据库文件可以理解为页的数组，可以伸缩。页被分为四类：空闲、树、锁字节、指针map。其中树页又可以细分为三类：中间页，叶子页，溢出页。所有的页中第一页是比较特殊的，它作为所有其他的页的根。</li>
<li>SQLite支持三种过时的日志类型：回滚，语句声明，多数据库事务。回滚日志存放多个日志段，每个日志段由一个日志段头和多条日志记录组成。日志记录则由页个数，旧页数据，校验和组成。语句声明日志则记录单个插入、更新、删除操作的执行影响的回滚日志。跨数据库事务日志存放的是所有参与单个事务的子回滚日志的路径。</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://www.sqlite.org/fileformat.html">Database File Format (sqlite.org)</a></li>
<li>SQLite Database System Design and Implementation</li>
<li>inside sqlite</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/05/sqlite%E8%99%9A%E6%8B%9F%E6%9C%BAvdbe%E5%88%9D%E8%A7%88-01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason Chao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我住8楼">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/05/sqlite%E8%99%9A%E6%8B%9F%E6%9C%BAvdbe%E5%88%9D%E8%A7%88-01/" class="post-title-link" itemprop="url">sqlite虚拟机vdbe初览-01</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-07-05 22:28:35 / 修改时间：22:40:35" itemprop="dateCreated datePublished" datetime="2021-07-05T22:28:35+08:00">2021-07-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Sqlite虚拟机"><a href="#Sqlite虚拟机" class="headerlink" title="Sqlite虚拟机"></a>Sqlite虚拟机</h1><p>数据结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">struct VdbeOp &#123;</span><br><span class="line">  u8 opcode;          &#x2F;* What operation to perform *&#x2F;</span><br><span class="line">  signed char p4type; &#x2F;* One of the P4_xxx constants for p4 *&#x2F;</span><br><span class="line">  u16 p5;             &#x2F;* Fifth parameter is an unsigned 16-bit integer *&#x2F;</span><br><span class="line">  int p1;             &#x2F;* First operand *&#x2F;</span><br><span class="line">  int p2;             &#x2F;* Second parameter (often the jump destination) *&#x2F;</span><br><span class="line">  int p3;             &#x2F;* The third parameter *&#x2F;</span><br><span class="line">  union p4union &#123;     &#x2F;* fourth parameter *&#x2F;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct VdbeSorter &#123;</span><br><span class="line">  int mnPmaSize;                  &#x2F;* Minimum PMA size, in bytes *&#x2F;</span><br><span class="line">  int mxPmaSize;                  &#x2F;* Maximum PMA size, in bytes.  0&#x3D;&#x3D;no limit *&#x2F;</span><br><span class="line">  int mxKeysize;                  &#x2F;* Largest serialized key seen so far *&#x2F;</span><br><span class="line">  int pgsz;                       &#x2F;* Main database page size *&#x2F;</span><br><span class="line">  PmaReader *pReader;             &#x2F;* Readr data from here after Rewind() *&#x2F;</span><br><span class="line">  MergeEngine *pMerger;           &#x2F;* Or here, if bUseThreads&#x3D;&#x3D;0 *&#x2F;</span><br><span class="line">  sqlite3 *db;                    &#x2F;* Database connection *&#x2F;</span><br><span class="line">  KeyInfo *pKeyInfo;              &#x2F;* How to compare records *&#x2F;</span><br><span class="line">  UnpackedRecord *pUnpacked;      &#x2F;* Used by VdbeSorterCompare() *&#x2F;</span><br><span class="line">  SorterList list;                &#x2F;* List of in-memory records *&#x2F;</span><br><span class="line">  int iMemory;                    &#x2F;* Offset of free space in list.aMemory *&#x2F;</span><br><span class="line">  int nMemory;                    &#x2F;* Size of list.aMemory allocation in bytes *&#x2F;</span><br><span class="line">  u8 bUsePMA;                     &#x2F;* True if one or more PMAs created *&#x2F;</span><br><span class="line">  u8 bUseThreads;                 &#x2F;* True to use background threads *&#x2F;</span><br><span class="line">  u8 iPrev;                       &#x2F;* Previous thread used to flush PMA *&#x2F;</span><br><span class="line">  u8 nTask;                       &#x2F;* Size of aTask[] array *&#x2F;</span><br><span class="line">  u8 typeMask;</span><br><span class="line">  SortSubtask aTask[1];           &#x2F;* One or more subtasks *&#x2F;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/25/vscode-wsl-%E8%B0%83%E8%AF%95sqlite/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason Chao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我住8楼">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/25/vscode-wsl-%E8%B0%83%E8%AF%95sqlite/" class="post-title-link" itemprop="url">vscode+wsl 调试sqlite</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-06-25 16:56:05 / 修改时间：23:06:22" itemprop="dateCreated datePublished" datetime="2021-06-25T16:56:05+08:00">2021-06-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h1><blockquote>
<p>环境要求：</p>
<ol>
<li>win10 1943 +</li>
<li>x86</li>
</ol>
</blockquote>
<h2 id="wsl-升级为wsl2"><a href="#wsl-升级为wsl2" class="headerlink" title="wsl 升级为wsl2"></a>wsl 升级为wsl2</h2><h3 id="开启linux子系统功能"><a href="#开启linux子系统功能" class="headerlink" title="开启linux子系统功能"></a>开启linux子系统功能</h3><p>以管理员身份打开powershell，在终端里执行以下命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism.exe &#x2F;online &#x2F;enable-feature &#x2F;featurename:Microsoft-Windows-Subsystem-Linux &#x2F;all &#x2F;norestart</span><br></pre></td></tr></table></figure>
<h3 id="开启虚拟机功能"><a href="#开启虚拟机功能" class="headerlink" title="开启虚拟机功能"></a>开启虚拟机功能</h3><p>WSL2需要使用虚拟机，因此需要在系统中启动虚拟机功能。</p>
<p>打开PowerShell，执行命令 ：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart</span><br></pre></td></tr></table></figure>
<p>然后重启系统</p>
<h3 id="下载linux子系统内核更新包并进行安装"><a href="#下载linux子系统内核更新包并进行安装" class="headerlink" title="下载linux子系统内核更新包并进行安装"></a>下载linux子系统内核更新包并进行安装</h3><p>链接如下<a target="_blank" rel="noopener" href="https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi">https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi</a></p>
<h3 id="设置WSL为版本2"><a href="#设置WSL为版本2" class="headerlink" title="设置WSL为版本2"></a>设置WSL为版本2</h3><p>打开PowerShell，执行命令 ：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --set-default-version 2</span><br></pre></td></tr></table></figure>
<h2 id="安装ubuntu20-04"><a href="#安装ubuntu20-04" class="headerlink" title="安装ubuntu20.04"></a>安装ubuntu20.04</h2><p>在Microsoft Store中搜索ubuntu，然后点击下面红框的第一个，点击安装即可</p>
<img src="/2021/06/25/vscode-wsl-%E8%B0%83%E8%AF%95sqlite/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16246301321799.png" class="" title="img">

<p>等待数分钟安装完成后，从开始菜单里找到ubuntu图标点击运行，第一次运行需要创建一个用户和密码，如下图所示：</p>
<img src="/2021/06/25/vscode-wsl-%E8%B0%83%E8%AF%95sqlite/ubuntuinstall.png" class="" title="Ubuntu unpacking in the Windows console">

<p>最后在powershell里运行以下命令，检查下是否为版本2，如下图所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl -l -v</span><br></pre></td></tr></table></figure>
<img src="/2021/06/25/vscode-wsl-%E8%B0%83%E8%AF%95sqlite/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16246306952275.png" class="" title="img">

<p>考虑到root账户比较好用，可以将ubuntu启动的默认用户为root</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ubuntu config --set-user root</span><br></pre></td></tr></table></figure>
<h2 id="安装vscode"><a href="#安装vscode" class="headerlink" title="安装vscode"></a>安装vscode</h2><p>从<a target="_blank" rel="noopener" href="https://code.visualstudio.com/Download">这里</a>下载vscode，并进行安装</p>
<p>然后安装插件Remote - WSL</p>
<img src="/2021/06/25/vscode-wsl-%E8%B0%83%E8%AF%95sqlite/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16246308755039.png" class="" title="img">

<p>这个插件可以在win10下链接到子系统ubuntu下</p>
<h2 id="Windows-Terminal"><a href="#Windows-Terminal" class="headerlink" title="Windows Terminal"></a>Windows Terminal</h2><p>原来的cmd不好用，建议在Microsoft Store里安装一下windows terminal，可以通过windows terminal直接终端的方式访问ubuntu子系统。如下图所示：</p>
<img src="/2021/06/25/vscode-wsl-%E8%B0%83%E8%AF%95sqlite/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16246310732630.png" class="" title="img">

<p>在这个终端里可以折腾一些好用的工具，例如ohMyZsh，vim等。也可以根据习惯设置其主题。最重要的是，可以启动tmux来管理多个终端，当要访问服务器时，tmux非常nice。完全可以当做iterm2 + tmux来使用，win10也能当做mac一般方便开发。</p>
<h1 id="编译sqlite3"><a href="#编译sqlite3" class="headerlink" title="编译sqlite3"></a>编译sqlite3</h1><h2 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h2><p>从github上下载想要查看的源码，链接是<a target="_blank" rel="noopener" href="https://github.com/sqlite/sqlite/releases">Releases · sqlite/sqlite (github.com)</a>，如果访问不了，那就去官网下载。建议下载分模块的代码，而不是汇总的代码。下图中红框的就是分模块的源码。未非模块的就只有sqlite3.h和sqlite3.c，所有逻辑都放到一块了。</p>
<img src="/2021/06/25/vscode-wsl-%E8%B0%83%E8%AF%95sqlite/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16246317134879.png" class="" title="img">

<h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><p>ubuntu的编译比较简单：</p>
<ol>
<li><p>需要安装gcc， g++，gdb，执行<code> apt-get install build-essential gdb</code></p>
</li>
<li><p>解压sqlite.zip的代码，然后编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tar xzf sqlite.tar.gz    ;#  Unpack the source tree into &quot;sqlite&quot;</span><br><span class="line">mkdir bld                ;#  Build will occur in a sibling directory</span><br><span class="line">cd bld                   ;#  Change to the build directory</span><br><span class="line">..&#x2F;sqlite&#x2F;configure  CFLAGS&#x3D;&#39;-g&#39; --enable-debug    ;#  Run the configure script</span><br><span class="line">make                     ;#  Run the makefile.</span><br><span class="line">make install             ;#  Install the sqlite3</span><br></pre></td></tr></table></figure>
<p>需要注意的是上面的configure，需要加两个配置，都是用来要求编译的动态库带上debug信息，方便后续debug sqlite源码时使用。</p>
</li>
</ol>
<p>编译时，需要使用libtool工具，因此可能需要提前安装下，执行以下命令即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install automake libtool </span><br></pre></td></tr></table></figure>
<h1 id="调试sqlite3源码"><a href="#调试sqlite3源码" class="headerlink" title="调试sqlite3源码"></a>调试sqlite3源码</h1><h2 id="vscode插件安装"><a href="#vscode插件安装" class="headerlink" title="vscode插件安装"></a>vscode插件安装</h2><p>打开vscode，先链接上ubuntu子系统，会提示你安装vscode server。</p>
<p>然后open folder里打开sqlite的源码目录</p>
<img src="/2021/06/25/vscode-wsl-%E8%B0%83%E8%AF%95sqlite/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16246324019401.png" class="" title="img">

<p>代码如下图所示：</p>
<p>随便查看一个c文件，会提示你安装c/c++ 插件，点击确定即可。</p>
<img src="/2021/06/25/vscode-wsl-%E8%B0%83%E8%AF%95sqlite/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16246324903106.png" class="" title="img">



<h2 id="编译调试"><a href="#编译调试" class="headerlink" title="编译调试"></a>编译调试</h2><p>在src目录下创建一个c文件，内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sqlite3.h&gt; </span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">callback</span><span class="params">(<span class="keyword">void</span> *NotUsed, <span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **azColName)</span></span>&#123;</span><br><span class="line">   <span class="keyword">int</span> i;</span><br><span class="line">   <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;argc; i++)&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%s = %s\n&quot;</span>, azColName[i], argv[i] ? argv[i] : <span class="string">&quot;NULL&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   sqlite3 *db;</span><br><span class="line">   <span class="keyword">char</span> *zErrMsg = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">int</span>  rc;</span><br><span class="line">   <span class="keyword">char</span> *sql;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Open database */</span></span><br><span class="line">   rc = sqlite3_open(<span class="string">&quot;test.db&quot;</span>, &amp;db);</span><br><span class="line">   <span class="keyword">if</span>( rc )&#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Can&#x27;t open database: %s\n&quot;</span>, sqlite3_errmsg(db));</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">&quot;Opened database successfully\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Create SQL statement */</span></span><br><span class="line">   sql = <span class="string">&quot;CREATE TABLE COMPANY(&quot;</span>  \</span><br><span class="line">         <span class="string">&quot;ID INT PRIMARY KEY     NOT NULL,&quot;</span> \</span><br><span class="line">         <span class="string">&quot;NAME           TEXT    NOT NULL,&quot;</span> \</span><br><span class="line">         <span class="string">&quot;AGE            INT     NOT NULL,&quot;</span> \</span><br><span class="line">         <span class="string">&quot;ADDRESS        CHAR(50),&quot;</span> \</span><br><span class="line">         <span class="string">&quot;SALARY         REAL );&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Execute SQL statement */</span></span><br><span class="line">   rc = sqlite3_exec(db, sql, callback, <span class="number">0</span>, &amp;zErrMsg);</span><br><span class="line">   <span class="keyword">if</span>( rc != SQLITE_OK )&#123;</span><br><span class="line">   <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;SQL error: %s\n&quot;</span>, zErrMsg);</span><br><span class="line">      sqlite3_free(zErrMsg);</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">&quot;Table created successfully\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   sqlite3_close(db);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后开始执行编译，快捷键是Ctrl+Shrift+B，实际上是目录的terminal-&gt;run Build Task。这个会在当前目录的.vscode下创建一个task.json文件，用来描述编译行为。注意，我们依赖sqlite3动态库，因此需要在args里添加一行”-lsqlite3”，不然会编译失败。</p>
<img src="/2021/06/25/vscode-wsl-%E8%B0%83%E8%AF%95sqlite/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16246329215768.png" class="" title="img">

<p>如下图所示：</p>
<p>也可以设置一个断点，然后按F5，或者Run-&gt;Start Debugging来启动调试功能。</p>
<img src="/2021/06/25/vscode-wsl-%E8%B0%83%E8%AF%95sqlite/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16246330559835.png" class="" title="img">

<p>这里需要注意的是，gdb可能链接的sqlite3动态库是，而这个库是不带debug信息的，导致debug时不会进入到sqlite的代码里。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libsqlite3.so.0</span><br></pre></td></tr></table></figure>
<p>这个也只是个软连接，指向的是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libsqlite3.so.0.8.6</span><br></pre></td></tr></table></figure>
<p>但是我们编译带debug信息的动态库安装的实际上是在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;lib&#x2F;libsqlite3.so.0.8.6</span><br></pre></td></tr></table></figure>
<p>因此把之前的软连接删除，然后再把软连接链接到我们安装的动态库上即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libsqlite3.so.0.8.6 &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libsqlite3.so.0</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">Install WSL on Windows 10 | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://code.visualstudio.com/">Visual Studio Code - Code Editing. Redefined</a></li>
<li><a target="_blank" rel="noopener" href="https://sqlite.org/src/doc/trunk/README.md">SQLite: SQLite Source Repository</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2021 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason Chao</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
